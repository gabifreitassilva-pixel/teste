<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>FISCAL AUDIT - SISTEMA DE AUDITORIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; padding: 40px; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 12px; padding: 20px; }
        .diff-neg { color: #ef4444; font-weight: bold; }
        .diff-pos { color: #10b981; }
    </style>
</head>
<body>
    <div class="flex justify-between items-center mb-10">
        <h1 class="text-3xl font-black text-orange-500 italic">PAINEL DE AUDITORIA (5 ANOS)</h1>
        <a href="index.html" class="bg-zinc-800 px-6 py-2 rounded text-sm uppercase font-bold">Voltar</a>
    </div>

    <div class="grid grid-cols-4 gap-6 mb-10">
        <div class="card"><h3>Total XML</h3><p id="total-xml" class="text-2xl font-bold">R$ 0,00</p></div>
        <div class="card"><h3>Total PGDAS</h3><p id="total-pgdas" class="text-2xl font-bold">R$ 0,00</p></div>
        <div class="card"><h3>Diferen√ßa</h3><p id="total-diff" class="text-2xl font-bold">R$ 0,00</p></div>
        <div class="card"><h3>Status</h3><p id="total-status" class="text-2xl font-bold">---</p></div>
    </div>

    <div class="card overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-zinc-900 text-orange-500 uppercase text-xs">
                <tr><th class="p-4">Per√≠odo</th><th class="p-4">XML (Faturamento Real)</th><th class="p-4">PGDAS (Declarado)</th><th class="p-4">Diferen√ßa</th><th class="p-4">Status</th></tr>
            </thead>
            <tbody id="audit-body"></tbody>
        </table>
    </div>

    <script>
        const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        function processAudit() {
            const xml = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const pgdas = JSON.parse(localStorage.getItem('pgdas_pdf_audit')) || [];
            const tbody = document.getElementById('audit-body');
            let sumXml = 0, sumPgdas = 0;

            const periodos = [...new Set([...xml.map(x=>x.ref), ...pgdas.map(p=>p.ref)])].sort();

            periodos.forEach(ref => {
                const valXml = xml.find(x=>x.ref===ref)?.itens.reduce((a,b)=>a+parseFloat(b.ValorTotal.replace('.','').replace(',','.')), 0) || 0;
                const valPgdas = pgdas.find(p=>p.ref===ref)?.atividades.reduce((a,b)=>a+parseFloat(b.rec.replace('.','').replace(',','.')), 0) || 0;
                const diff = valPgdas - valXml;
                
                sumXml += valXml; sumPgdas += valPgdas;

                tbody.innerHTML += `
                    <tr class="border-b border-zinc-900">
                        <td class="p-4">${ref}</td>
                        <td class="p-4">${fmt(valXml)}</td>
                        <td class="p-4">${fmt(valPgdas)}</td>
                        <td class="p-4 ${diff < -1 ? 'diff-neg' : 'diff-pos'}">${fmt(diff)}</td>
                        <td class="p-4">${diff < -1 ? 'üî¥ Divergente' : 'üü¢ OK'}</td>
                    </tr>`;
            });

            document.getElementById('total-xml').innerText = fmt(sumXml);
            document.getElementById('total-pgdas').innerText = fmt(sumPgdas);
            document.getElementById('total-diff').innerText = fmt(sumPgdas - sumXml);
        }
        processAudit();
    </script>
</body>
</html>
