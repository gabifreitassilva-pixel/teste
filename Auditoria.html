<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AUDITORIA INTELIGENTE & CORREÇÃO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #050505; color: #fff; font-family: 'Inter', sans-serif; padding: 20px; }
        .card { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 8px; padding: 15px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 11px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #f97316; color: #000; }
        .btn-primary:hover { background: #fff; }
        .btn-action { background: #1a1a1a; border: 1px solid #333; color: #ccc; }
        .btn-action:hover { border-color: #f97316; color: #fff; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #111; color: #f97316; text-align: left; padding: 10px; border-bottom: 2px solid #222; }
        td { padding: 8px 10px; border-bottom: 1px solid #1a1a1a; color: #ccc; }
        tr.error-row { background: rgba(239, 68, 68, 0.05); }
        tr.error-row:hover { background: rgba(239, 68, 68, 0.1); }
        #edit-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 50; }
        .modal-box { background: #0f0f0f; width: 500px; padding: 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 0 50px rgba(249, 115, 22, 0.1); }
    </style>
</head>
<body>
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-black italic text-white">ROBÔ DE <span class="text-orange-500">AUDITORIA</span></h1>
            <p class="text-zinc-500 text-xs">Cruzamento: XML vs. Legislação (Convênio 142/18 e PIS/COFINS)</p>
        </div>
        <div class="flex gap-3">
            <a href="index.html" class="btn btn-action">Voltar</a>
            <button onclick="runAuditBot()" class="btn btn-primary"><i class="fas fa-play mr-2"></i> Iniciar Análise</button>
        </div>
    </div>

    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="card border-l-4 border-blue-500">
            <h3 class="text-xs text-zinc-500 font-bold uppercase">Itens Analisados</h3>
            <p id="count-items" class="text-2xl font-black">0</p>
        </div>
        <div class="card border-l-4 border-red-500">
            <h3 class="text-xs text-zinc-500 font-bold uppercase">Inconsistências</h3>
            <p id="count-errors" class="text-2xl font-black text-red-500">0</p>
        </div>
        <div class="card border-l-4 border-green-500">
            <h3 class="text-xs text-zinc-500 font-bold uppercase">Recuperável (Est.)</h3>
            <p id="val-recover" class="text-2xl font-black text-green-500">R$ 0,00</p>
        </div>
        <div class="card border-l-4 border-orange-500">
            <h3 class="text-xs text-zinc-500 font-bold uppercase">Faturamento XML</h3>
            <p id="val-xml" class="text-2xl font-black">R$ 0,00</p>
        </div>
    </div>

    <div class="card p-0 overflow-hidden">
        <div class="max-h-[500px] overflow-y-auto">
            <table id="audit-table">
                <thead>
                    <tr>
                        <th width="80">Data</th>
                        <th>Produto / NCM Original</th>
                        <th>CST Atual</th>
                        <th>Sugestão do Robô</th>
                        <th>Status</th>
                        <th width="120">Ação</th>
                    </tr>
                </thead>
                <tbody id="audit-body">
                    <tr><td colspan="6" class="text-center py-10 text-zinc-600">Clique em "Iniciar Análise" para o robô ler a legislação.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="edit-modal">
        <div class="modal-box">
            <h3 class="text-orange-500 font-bold text-lg mb-4">Correção Manual de Item</h3>
            <input type="hidden" id="edit-index">
            <label class="block text-xs text-zinc-500 mb-1">Produto</label>
            <input type="text" id="edit-prod" class="w-full bg-black border border-zinc-700 text-white p-2 rounded mb-3 text-sm" disabled>
            <div class="grid grid-cols-2 gap-4 mb-3">
                <div>
                    <label class="block text-xs text-zinc-500 mb-1">NCM</label>
                    <input type="text" id="edit-ncm" class="w-full bg-black border border-zinc-700 text-white p-2 rounded text-sm focus:border-orange-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 mb-1">CST / CSOSN</label>
                    <select id="edit-cst" class="w-full bg-black border border-zinc-700 text-white p-2 rounded text-sm focus:border-orange-500 outline-none">
                        <option value="102">102 - Tributado SN</option>
                        <option value="500">500 - ICMS ST</option>
                        <option value="01">01 - Tributado Integral</option>
                        <option value="04">04 - Monofásico PIS/COFINS</option>
                        <option value="06">06 - Alíquota Zero</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="btn btn-action">Cancelar</button>
                <button onclick="saveCorrection()" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        const RULE_SET = {
            MONOFASICO: ['2203', '2202', '210690', '8708', '4011', '3303', '3304', '3305', '3307', '3004', '4013', '7009'],
            ST_ICMS: ['2203', '2202', '3208', '3209', '3401', '3917', '3919', '3923', '4011', '4013', '6907', '7009', '7318']
        };
        let currentData = [];

        function runAuditBot() {
            const xmlHistory = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            currentData = [];
            let totalXml = 0;

            xmlHistory.forEach(lote => {
                lote.itens.forEach(item => {
                    const valor = parseFloat(item.ValorTotal.replace('.','').replace(',','.'));
                    totalXml += valor;
                    currentData.push({ ...item, id: Math.random(), status: 'PENDENTE', sugestao: '', valor });
                });
            });

            document.getElementById('val-xml').innerText = totalXml.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

            let errors = 0, recoveryPot = 0;
            currentData.forEach(item => {
                const ncm = item.NCM.replace(/\./g, '');
                const cst = item.CSOSN || item.CST_PIS;
                const isMono = RULE_SET.MONOFASICO.some(r => ncm.startsWith(r));
                const isST = RULE_SET.ST_ICMS.some(r => ncm.startsWith(r));
                const isTrib = cst === '102' || cst === '01';

                if ((isMono || isST) && isTrib) {
                    item.status = 'ERRO';
                    item.sugestao = isMono ? 'Sugerido: Monofásico (04)' : 'Sugerido: ICMS-ST (500)';
                    errors++;
                    recoveryPot += item.valor;
                } else {
                    item.status = 'OK';
                    item.sugestao = 'Correto';
                }
            });

            document.getElementById('count-items').innerText = currentData.length;
            document.getElementById('count-errors').innerText = errors;
            document.getElementById('val-recover').innerText = recoveryPot.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('audit-body');
            tbody.innerHTML = '';
            currentData.sort((a, b) => (a.status === 'ERRO' ? -1 : 1));
            currentData.slice(0, 500).forEach((item, index) => {
                const isErr = item.status === 'ERRO';
                tbody.innerHTML += `
                    <tr class="${isErr ? 'error-row' : ''}">
                        <td>${item.Data}</td>
                        <td><div class="font-bold text-white">${item.Produto}</div><div class="text-[10px] text-zinc-500">${item.NCM}</div></td>
                        <td class="${isErr ? 'text-red-400 font-bold' : ''}">${item.CSOSN || item.CST_PIS}</td>
                        <td class="text-xs ${isErr ? 'text-orange-400' : 'text-zinc-500'}">${item.sugestao}</td>
                        <td><span class="badge ${isErr ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'} px-2 py-1 rounded text-[9px] font-bold">${item.status}</span></td>
                        <td><button onclick="openEditModal(${index})" class="bg-zinc-800 text-white px-3 py-1 rounded text-xs">Editar</button></td>
                    </tr>`;
            });
        }

        let editIdx = -1;
        function openEditModal(i) {
            editIdx = i;
            document.getElementById('edit-prod').value = currentData[i].Produto;
            document.getElementById('edit-ncm').value = currentData[i].NCM;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        function saveCorrection() {
            if(editIdx > -1) {
                currentData[editIdx].NCM = document.getElementById('edit-ncm').value;
                currentData[editIdx].CSOSN = document.getElementById('edit-cst').value;
                currentData[editIdx].status = 'CORRIGIDO';
                renderTable();
                closeModal();
            }
        }
    </script>
</body>
</html>
