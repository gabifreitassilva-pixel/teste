// --- FUNÇÃO DE CONVERSÃO DE DATA PARA EXTENSO ---
function formatarPeriodoExtenso(textoPeriodo) {
    // Espera formato "01/11/2025 a 30/11/2025"
    const match = textoPeriodo.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if (!match) return textoPeriodo;
    const mesIdx = parseInt(match[2]) - 1;
    const ano = match[3];
    return `${MONTHS_FULL[mesIdx]} DE ${ano}`;
}

// --- PROCESSAMENTO PGDAS MELHORADO ---
async function processarPGDAS() {
    const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
    let processados = 0;

    for (let file of pgdasFiles) {
        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            // Mantém espaços para melhor filtragem via Regex
            fullText += content.items.map(item => item.str).join(" ") + " ";
        }

        // 1. Identificação Básica [cite: 13, 14, 84, 91, 92]
        const cnpj = (fullText.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/) || [""])[0];
        const nomeEmpresa = (fullText.match(/Nome empresarial:\s*(.*?)\s*Data de abertura/i) || ["", "Empresa não identificada"])[1].trim();
        const periodoBruto = (fullText.match(/Período de Apuração:\s*([\d/]+ a [\d/]+)/) || ["", ""])[1];
        const periodoExtenso = formatarPeriodoExtenso(periodoBruto);

        // 2. Receitas Brutas (Competência e RBT12) 
        // Captura o primeiro valor após a descrição da receita na tabela de Discriminativo
        const receitaComp = (fullText.match(/Receita Bruta do PA \(RPA\) Competência\s*([\d\.,]+)/) || ["", "0,00"])[1];
        const rbt12 = (fullText.match(/Receita bruta acumulada nos doze meses anteriores ao PA \(RBT12\)\s*([\d\.,]+)/) || ["", "0,00"])[1];

        // 3. Extração Dinâmica de Atividades (Seção 2.7) 
        // Regex para capturar a descrição da atividade até a "Receita Bruta Informada"
        const atividades = [];
        const atividadeRegex = /Valor do Débito por Tributo para a Atividade \(R\$\): (.*?) Receita Bruta Informada: R\$ ([\d\.,]+) (IRPJ.*?Total.*?[\d\., ]+)/gi;
        
        let match;
        while ((match = atividadeRegex.exec(fullText)) !== null) {
            const descricao = match[1].trim();
            const receitaInformada = match[2];
            
            // Captura os valores da tabela de impostos abaixo da atividade 
            // Espera-se 9 valores: IRPJ, CSLL, COFINS, PIS, INSS, ICMS, IPI, ISS, Total
            const valoresStr = match[3].replace(/[a-zA-Z\/]/g, '').trim();
            const v = valoresStr.split(/\s+/);

            atividades.push({
                descricao,
                receitaInformada,
                tributos: {
                    irpj: v[0] || "0,00", csll: v[1] || "0,00", cofins: v[2] || "0,00",
                    pis: v[3] || "0,00", inss: v[4] || "0,00", icms: v[5] || "0,00",
                    ipi: v[6] || "0,00", iss: v[7] || "0,00", total: v[8] || "0,00"
                }
            });
        }

        h.push({
            empresa: nomeEmpresa,
            cnpj: cnpj,
            ref: periodoExtenso,
            receitaComp,
            rbt12,
            atividades,
            totalDas: (fullText.match(/Valor Total do DAS: R\$ ([\d\.,]+)/) || ["", "0,00"])[1]
        });
        processados++;
    }

    localStorage.setItem('pgdas_history', JSON.stringify(h));
    alert(`${processados} PGDAS Processados com sucesso!`);
    renderPGDASHistory();
}

// --- RENDERIZAÇÃO DA TABELA DE HISTÓRICO ---
function renderPGDASHistory() {
    const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
    document.getElementById('tbody-pgdas').innerHTML = h.map((item, idx) => `
        <tr class="border-b border-zinc-900">
            <td class="py-4">
                <div class="font-bold text-white">${item.empresa}</div>
                <div class="text-[9px] text-zinc-500">${item.cnpj}</div>
            </td>
            <td><span class="badge badge-success">${item.ref}</span></td>
            <td>
                <div class="text-[10px] text-zinc-300"><b>Comp:</b> R$ ${item.receitaComp}</div>
                <div class="text-[10px] text-zinc-500"><b>RBT12:</b> R$ ${item.rbt12}</div>
            </td>
            <td>
                ${item.atividades.map(atv => `
                    <div class="mb-2 p-2 bg-black/50 rounded border border-zinc-800">
                        <div class="text-[9px] text-orange-500 font-bold uppercase">${atv.descricao}</div>
                        <div class="text-[10px] text-white">Receita: R$ ${atv.receitaInformada}</div>
                        <div class="grid grid-cols-4 gap-1 mt-1 text-[8px] text-zinc-400">
                            <span>IRPJ: ${atv.tributos.irpj}</span>
                            <span>CSLL: ${atv.tributos.csll}</span>
                            <span>COF: ${atv.tributos.cofins}</span>
                            <span>PIS: ${atv.tributos.pis}</span>
                            <span>INSS: ${atv.tributos.inss}</span>
                            <span>ICMS: ${atv.tributos.icms}</span>
                            <span>IPI: ${atv.tributos.ipi}</span>
                            <span>ISS: ${atv.tributos.iss}</span>
                        </div>
                    </div>
                `).join('')}
            </td>
            <td class="font-bold text-orange-500">R$ ${item.totalDas}</td>
            <td><i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteHistory('pgdas', ${idx})"></i></td>
        </tr>
    `).join('');
}
