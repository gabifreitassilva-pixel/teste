<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - MASTER V18</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; }
        .nav-link { padding: 12px 25px; font-size: 11px; font-weight: 600; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-link.active { color: var(--orange-main); background: rgba(249, 115, 22, 0.05); border-left-color: var(--orange-main); }
        .main-container { flex: 1; background: #050505; overflow-y: auto; padding: 30px; }
        .card-panel { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-orange { background: var(--orange-main); color: #000; font-weight: 800; border-radius: 6px; padding: 10px 20px; font-size: 11px; text-transform: uppercase; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #111; color: var(--orange-main); padding: 15px; text-align: left; border-bottom: 2px solid #222; }
        td { padding: 15px; border-bottom: 1px solid #1a1a1a; color: #ccc; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-6 text-center border-b border-zinc-900">
            <h1 class="text-2xl font-black italic text-white">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
        </div>
        <nav class="flex-1 mt-4">
            <div class="nav-link active" onclick="showTab('extrator', this)"><i class="fas fa-upload"></i> Carga</div>
            <div class="nav-link" onclick="showTab('xml-hist', this)"><i class="fas fa-file-code"></i> Histórico XML</div>
            <div class="nav-link" onclick="showTab('pgdas-hist', this)"><i class="fas fa-file-invoice-dollar"></i> Histórico PGDAS</div>
        </nav>
    </aside>

    <main class="main-container">
        <div id="extrator" class="tab-content active">
            <h2 class="text-2xl font-black italic mb-6">MÓDULO DE CARGA</h2>
            <div class="grid grid-cols-2 gap-6">
                <div class="card-panel">
                    <p class="text-[10px] font-bold text-orange-500 uppercase mb-4">Upload XML / ZIP</p>
                    <div class="border-2 border-dashed border-zinc-800 p-8 text-center cursor-pointer" onclick="document.getElementById('xml-in').click()">
                        <span id="txt-xml">Selecionar Arquivos</span>
                        <input type="file" id="xml-in" multiple accept=".xml,.zip" class="hidden" onchange="handleXML(this.files)">
                    </div>
                    <button class="btn-orange w-full mt-4" onclick="processarXML()">Processar Todas as Tags</button>
                </div>
            </div>
        </div>

        <div id="xml-hist" class="tab-content">
            <h2 class="text-2xl font-black italic mb-6">HISTÓRICO XML (TAGS COMPLETAS)</h2>
            <div class="card-panel overflow-x-auto">
                <table>
                    <thead>
                        <tr><th>Empresa</th><th>Ref</th><th>Itens</th><th>Ações</th></tr>
                    </thead>
                    <tbody id="tbody-xml"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let xmlBuffer = [];
        const MONTHS_FULL = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'xml-hist') renderXML();
        }

        async function handleXML(files) {
            xmlBuffer = [];
            for(let f of files) {
                if(f.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(f);
                    for(let path in zip.files) {
                        if(path.endsWith('.xml')) xmlBuffer.push(await zip.files[path].async("text"));
                    }
                } else { xmlBuffer.push(await f.text()); }
            }
            document.getElementById('txt-xml').innerText = xmlBuffer.length + " Arquivos";
        }

        // FUNÇÃO DE EXTRAÇÃO RECURSIVA (CAPTURA TODAS AS TAGS)
        function xmlToObj(node) {
            const obj = {};
            Array.from(node.children).forEach(child => {
                if (child.children.length > 0) {
                    obj[child.tagName] = xmlToObj(child);
                } else {
                    obj[child.tagName] = child.textContent;
                }
            });
            return obj;
        }

        function processarXML() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const parser = new DOMParser();

            xmlBuffer.forEach(text => {
                const xml = parser.parseFromString(text, "text/xml");
                const ide = xml.getElementsByTagName("ide")[0];
                const emit = xml.getElementsByTagName("emit")[0];
                if(!ide || !emit) return;

                const dEmi = ide.getElementsByTagName("dEmi")[0]?.textContent;
                const ref = dEmi ? `${MONTHS_FULL[parseInt(dEmi.substring(4,6))-1]}/${dEmi.substring(0,4)}` : "N/A";
                const cnpj = emit.getElementsByTagName("CNPJ")[0]?.textContent;
                const key = `${cnpj}_${ref}`;

                let group = h.find(x => x.key === key);
                if(!group) {
                    group = { key, empresa: emit.getElementsByTagName("xNome")[0]?.textContent, cnpj, ref, itens: [] };
                    h.push(group);
                }

                const dets = xml.getElementsByTagName("det");
                for(let det of dets) {
                    // Mapeia todas as tags dentro de <det> recursivamente
                    group.itens.push(xmlToObj(det));
                }
            });

            localStorage.setItem('xml_audit_history', JSON.stringify(h));
            alert("Processado com sucesso!");
            renderXML();
        }

        function renderXML() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            document.getElementById('tbody-xml').innerHTML = h.map(g => `
                <tr>
                    <td>${g.empresa}<br><small>${g.cnpj}</small></td>
                    <td>${g.ref}</td>
                    <td>${g.itens.length} produtos</td>
                    <td><button onclick="console.log(JSON.parse(localStorage.getItem('xml_audit_history')))" class="text-orange-500">Log Tags</button></td>
                </tr>
            `).join('');
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
