<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - SISTEMA INTEGRADO V18 (MASTER)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--bg-dark); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .section-title { padding: 15px 25px 5px; font-size: 9px; font-weight: 900; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
        .nav-link { padding: 10px 25px; font-size: 11px; font-weight: 600; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--orange-main); background: rgba(249, 115, 22, 0.05); border-left-color: var(--orange-main); }
        .main-container { flex: 1; background: #050505; overflow-y: auto; padding: 30px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .card-panel { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--orange-main); color: #000 !important; font-weight: 800; border-radius: 6px; padding: 10px 20px; text-transform: uppercase; font-size: 11px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .table-container { border: 1px solid var(--border-color); border-radius: 8px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #111; color: var(--orange-main); font-size: 11px; text-transform: uppercase; padding: 15px; text-align: left; font-weight: 900; border-bottom: 2px solid #222; }
        td { padding: 15px; font-size: 11px; border-bottom: 1px solid #1a1a1a; color: #ccc; vertical-align: top; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-6 border-b border-zinc-900 mb-2 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
        </div>
        <nav class="flex-1">
            <div class="section-title">Extração</div>
            <div class="nav-link active" onclick="showTab('extrator-panel', this)"><i class="fas fa-upload"></i> Módulo de Carga</div>
            <div class="section-title">Consultas</div>
            <div class="nav-link" onclick="showTab('xml-history-panel', this)"><i class="fas fa-file-code"></i> Histórico XML</div>
            <div class="nav-link" onclick="showTab('pgdas-history-panel', this)"><i class="fas fa-file-invoice-dollar"></i> Histórico PGDAS</div>
        </nav>
    </aside>

    <main class="main-container">
        
        <div id="extrator-panel" class="tab-content active">
            <h2 class="text-2xl font-black italic text-white uppercase mb-6">Módulo de Carga</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload XML / ZIP (SAT/NFe)</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('xml-input').click()">
                        <p id="label-xml" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="xml-input" multiple accept=".xml,.zip" class="hidden" onchange="handleXMLFiles(this.files)">
                    </div>
                    <button id="btn-run-xml" onclick="processarXML()" class="btn-orange mt-4 w-full justify-center" disabled>Processar Notas (Tags Totais)</button>
                </div>
            </div>
        </div>

        <div id="xml-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Histórico XML</h2>
                <button onclick="exportBatchByCNPJ()" class="btn-orange"><i class="fas fa-file-excel"></i> Exportar Excel (Todas as Tags)</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th width="40"><input type="checkbox" onclick="toggleChecks(this)"></th><th>Empresa / CNPJ</th><th>Competência</th><th>Itens Extraídos</th><th>Ações</th></tr></thead>
                    <tbody id="tbody-xml"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        const MONTHS_FULL = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        let xmlBuffer = [];

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
            if(id === 'xml-history-panel') renderXMLHistory();
        }

        async function handleXMLFiles(files) {
            xmlBuffer = [];
            const loadFile = async (f) => {
                if (f.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(f);
                    const promises = Object.keys(zip.files).filter(p => p.toLowerCase().endsWith('.xml')).map(p => zip.files[p].async("text"));
                    return Promise.all(promises);
                }
                return [await f.text()];
            };
            const results = await Promise.all(Array.from(files).map(loadFile));
            xmlBuffer = results.flat();
            document.getElementById('label-xml').innerText = `${xmlBuffer.length} Arquivos Carregados`;
            document.getElementById('btn-run-xml').disabled = false;
        }

        // --- MOTOR DE EXTRAÇÃO RECURSIVA PARA TODAS AS TAGS ---
        function xmlToObj(node) {
            const obj = {};
            Array.from(node.children).forEach(child => {
                if (child.children.length > 0) {
                    obj[child.tagName] = xmlToObj(child);
                } else {
                    obj[child.tagName] = child.textContent;
                }
            });
            return obj;
        }

        function processarXML() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const parser = new DOMParser();

            xmlBuffer.forEach(text => {
                const xml = parser.parseFromString(text, "text/xml");
                const ide = xml.getElementsByTagName("ide")[0];
                const emit = xml.getElementsByTagName("emit")[0];
                if(!ide || !emit) return;

                const dEmi = ide.getElementsByTagName("dEmi")[0]?.textContent;
                const ref = dEmi ? `${MONTHS_FULL[parseInt(dEmi.substring(4,6))-1]}/${dEmi.substring(0,4)}` : "N/A";
                const cnpjRaw = emit.getElementsByTagName("CNPJ")[0]?.textContent;
                const key = `${cnpjRaw}_${ref}`;

                let group = h.find(x => x.key === key);
                if(!group) {
                    group = { key, empresa: emit.getElementsByTagName("xNome")[0]?.textContent, cnpj: cnpjRaw, ref, itens: [] };
                    h.push(group);
                }

                const dets = xml.getElementsByTagName("det");
                for(let det of dets) {
                    // Captura recursiva de todas as tags dentro do item
                    group.itens.push(xmlToObj(det));
                }
            });

            localStorage.setItem('xml_audit_history', JSON.stringify(h));
            alert("XMLs processados com sucesso!");
            renderXMLHistory();
        }

        function renderXMLHistory() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            document.getElementById('tbody-xml').innerHTML = h.map((item, idx) => `
                <tr>
                    <td class="text-center"><input type="checkbox" class="xml-sel" data-idx="${idx}"></td>
                    <td><b>${item.empresa}</b><br><small>${item.cnpj}</small></td>
                    <td>${item.ref}</td>
                    <td>${item.itens.length} tags mapeadas</td>
                    <td><i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteItem(${idx})"></i></td>
                </tr>
            `).join('');
        }

        // --- RELATÓRIO EXCEL DINÂMICO (TODAS AS TAGS) ---
        function flattenObject(obj, prefix = '') {
            let entries = {};
            for (let key in obj) {
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    Object.assign(entries, flattenObject(obj[key], prefix + key + '_'));
                } else {
                    entries[prefix + key] = obj[key];
                }
            }
            return entries;
        }

        function exportBatchByCNPJ() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const selected = Array.from(document.querySelectorAll('.xml-sel:checked')).map(cb => h[cb.dataset.idx]);
            if(!selected.length) return alert("Selecione ao menos um item!");

            let allRows = [];
            selected.forEach(lote => {
                lote.itens.forEach(item => {
                    allRows.push({ Empresa: lote.empresa, CNPJ: lote.cnpj, Referencia: lote.ref, ...flattenObject(item) });
                });
            });

            const headers = Array.from(new Set(allRows.flatMap(r => Object.keys(r))));
            let csv = "\ufeff" + headers.join(";") + "\n";
            allRows.forEach(row => {
                csv += headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(";") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `RELATORIO_TOTAL_TAGS_${Date.now()}.csv`;
            link.click();
        }

        function toggleChecks(s) { document.querySelectorAll('.xml-sel').forEach(c => c.checked = s.checked); }
        function deleteItem(idx) { 
            let h = JSON.parse(localStorage.getItem('xml_audit_history'));
            h.splice(idx,1); 
            localStorage.setItem('xml_audit_history', JSON.stringify(h)); 
            renderXMLHistory(); 
        }
    </script>
</body>
</html>
