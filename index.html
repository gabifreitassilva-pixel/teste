<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - V11.2 MASTER RECOVERY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Estilizada */
        .sidebar { width: 260px; background: var(--bg-dark); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; }
        .nav-link { padding: 12px 25px; font-size: 10px; font-weight: 700; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-transform: uppercase; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--orange-main); background: #080808; border-left-color: var(--orange-main); }
        .section-title { padding: 20px 25px 8px; font-size: 9px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Main Content */
        .main-container { flex: 1; background: #050505; overflow-y: auto; padding: 40px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Módulo de Carga */
        .drop-zone { border: 2px dashed #1a1a1a; border-radius: 12px; padding: 40px; text-align: center; transition: 0.3s; cursor: pointer; }
        .drop-zone:hover { border-color: var(--orange-main); background: #080808; }
        .btn-action { background: var(--orange-main); color: #000; font-weight: 900; border-radius: 8px; padding: 14px; text-transform: uppercase; font-size: 11px; width: 100%; transition: 0.2s; }
        .btn-action:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Tabelas e Cards */
        .table-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #080808; color: var(--orange-main); font-size: 10px; text-transform: uppercase; padding: 15px; text-align: left; }
        td { padding: 12px 15px; font-size: 11px; border-bottom: 1px solid #111; color: #ccc; }
        .activity-item { background: #0d0d0d; border-left: 3px solid var(--orange-main); padding: 10px; margin-bottom: 8px; border-radius: 4px; }
        .tax-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .tax-box { font-size: 9px; }
        .tax-box label { color: #555; display: block; font-weight: 800; }
        .tax-box span { color: var(--orange-main); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 border-b border-zinc-900 mb-4">
            <h1 class="text-2xl font-black italic tracking-tighter">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
            <p class="text-[8px] text-zinc-600 font-bold uppercase">V11.2 - Master Recovery</p>
        </div>
        <nav>
            <div class="section-title">Extração</div>
            <div class="nav-link active" onclick="showTab('carga-panel', this)"><i class="fas fa-upload"></i> Módulo de Carga</div>
            <div class="section-title">Resultados</div>
            <div class="nav-link" onclick="showTab('xml-panel', this)"><i class="fas fa-file-code"></i> Histórico XML</div>
            <div class="nav-link" onclick="showTab('pgdas-panel', this)"><i class="fas fa-file-invoice"></i> Histórico PGDAS</div>
            <div class="section-title">Legislação</div>
            <div class="nav-link" onclick="showTab('legis-panel', this)"><i class="fas fa-book"></i> Ver Legislações</div>
        </nav>
    </aside>

    <main class="main-container">
        <div id="carga-panel" class="tab-content active">
            <h2 class="text-3xl font-black italic mb-8 uppercase">Central de <span class="text-orange-500">Carga</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-[#0a0a0a] p-6 rounded-xl border border-zinc-900">
                    <h3 class="text-orange-500 font-black text-xs uppercase mb-4">Notas Fiscais (XML/ZIP)</h3>
                    <div class="drop-zone" onclick="document.getElementById('xml-input').click()">
                        <i class="fas fa-cloud-upload-alt text-3xl mb-4 text-zinc-700"></i>
                        <p id="xml-label" class="text-[10px] font-bold text-zinc-500 uppercase">Selecione arquivos ou arraste</p>
                        <input type="file" id="xml-input" multiple accept=".xml,.zip" class="hidden" onchange="handleXML(this.files)">
                    </div>
                    <button id="btn-xml" onclick="processXML()" class="btn-action mt-6" disabled>Gravar no Banco de Dados</button>
                </div>
                <div class="bg-[#0a0a0a] p-6 rounded-xl border border-zinc-900">
                    <h3 class="text-orange-500 font-black text-xs uppercase mb-4">PGDAS-D (PDF)</h3>
                    <div class="drop-zone" onclick="document.getElementById('pgdas-input').click()">
                        <i class="fas fa-file-pdf text-3xl mb-4 text-zinc-700"></i>
                        <p id="pgdas-label" class="text-[10px] font-bold text-zinc-500 uppercase">Selecione PDFs em Lote</p>
                        <input type="file" id="pgdas-input" multiple accept=".pdf" class="hidden" onchange="handlePGDAS(this.files)">
                    </div>
                    <button id="btn-pgdas" onclick="processPGDAS()" class="btn-action mt-6" disabled>Extrair e Gravar PGDAS</button>
                </div>
            </div>
        </div>

        <div id="xml-panel" class="tab-content">
            <h2 class="text-2xl font-black mb-6">HISTÓRICO DE EXTRAÇÃO XML</h2>
            <div class="table-container">
                <table id="xml-table">
                    <thead><tr><th>Empresa</th><th>Referência</th><th>Notas</th><th>Ações</th></tr></thead>
                    <tbody id="xml-body"></tbody>
                </table>
            </div>
        </div>

        <div id="pgdas-panel" class="tab-content">
            <h2 class="text-2xl font-black mb-6">HISTÓRICO PGDAS (PDF)</h2>
            <div class="table-container">
                <table id="pgdas-table">
                    <thead><tr><th>Empresa / Período</th><th>RBT12</th><th>Detalhamento por Atividade</th><th>Total DAS</th></tr></thead>
                    <tbody id="pgdas-body"></tbody>
                </table>
            </div>
        </div>

        <div id="legis-panel" class="tab-content">
             <h2 class="text-2xl font-black mb-6 italic">BIBLIOTECA <span class="text-orange-500">FISCAL</span></h2>
             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                 <a href="base reduzida.html" target="_blank" class="p-6 bg-[#0a0a0a] border-l-4 border-orange-500 rounded-lg hover:bg-zinc-900 transition">
                    <h4 class="font-black text-[11px] uppercase">Base Reduzida SP</h4>
                    <p class="text-[9px] text-zinc-500 mt-2">Anexo II - Regulamento ICMS</p>
                 </a>
                 <a href="pis e cofins.html" target="_blank" class="p-6 bg-[#0a0a0a] border-l-4 border-green-500 rounded-lg hover:bg-zinc-900 transition">
                    <h4 class="font-black text-[11px] uppercase">PIS e COFINS</h4>
                    <p class="text-[9px] text-zinc-500 mt-2">Monofásicos e Alíquota Zero</p>
                 </a>
                 </div>
        </div>
    </main>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        let xmlBuffer = [];
        let pgdasFiles = [];
        const MESES = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'xml-panel') renderXMLTable();
            if(id === 'pgdas-panel') renderPGDASTable();
        }

        // --- MOTOR DE EXTRAÇÃO XML (V10.2 RESTAURADO) ---
        async function handleXML(files) {
            xmlBuffer = [];
            for (let f of files) {
                if (f.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(f);
                    for (let path of Object.keys(zip.files)) {
                        if (path.endsWith('.xml')) xmlBuffer.push(await zip.files[path].async("text"));
                    }
                } else { xmlBuffer.push(await f.text()); }
            }
            document.getElementById('xml-label').innerText = `${xmlBuffer.length} arquivos carregados`;
            document.getElementById('btn-xml').disabled = false;
        }

        function processXML() {
            const history = JSON.parse(localStorage.getItem('audit_xml_db')) || [];
            const groups = {};
            
            xmlBuffer.forEach(raw => {
                const xml = new DOMParser().parseFromString(raw, "text/xml");
                const emit = xml.getElementsByTagName("emit")[0];
                const ide = xml.getElementsByTagName("ide")[0];
                if(!emit || !ide) return;

                const cnpj = emit.getElementsByTagName("CNPJ")[0]?.textContent;
                const nome = emit.getElementsByTagName("xNome")[0]?.textContent;
                const data = ide.getElementsByTagName("dhEmi")[0]?.textContent || ide.getElementsByTagName("dEmi")[0]?.textContent;
                const m = parseInt(data.substring(5,7));
                const a = data.substring(0,4);
                const ref = `${MESES[m-1]}/${a}`;
                const key = `${cnpj}_${m}_${a}`;

                if(!groups[key]) {
                    groups[key] = { key, empresa: nome, cnpj, ref, mSort: parseInt(a+m), nNF: new Set(), itens: [] };
                }

                const notas = xml.getElementsByTagName("det");
                groups[key].nNF.add(ide.getElementsByTagName("nNF")[0]?.textContent);

                Array.from(notas).forEach(det => {
                    const ncm = det.getElementsByTagName("NCM")[0]?.textContent;
                    const vProd = parseFloat(det.getElementsByTagName("vProd")[0]?.textContent || 0);
                    const pisCST = det.getElementsByTagName("PIS")[0]?.getElementsByTagName("CST")[0]?.textContent;
                    
                    groups[key].itens.push({
                        nota: ide.getElementsByTagName("nNF")[0]?.textContent,
                        prod: det.getElementsByTagName("xProd")[0]?.textContent,
                        ncm,
                        vProd,
                        pisCST,
                        credito: (["2105", "2202", "8708"].some(p => ncm?.startsWith(p)) && pisCST === "01") ? (vProd * 0.0198).toFixed(2) : 0
                    });
                });
            });

            Object.values(groups).forEach(g => {
                if(!history.find(h => h.key === g.key)) {
                    history.push({...g, nNF: g.nNF.size});
                }
            });

            localStorage.setItem('audit_xml_db', JSON.stringify(history));
            alert("Processamento Concluído com Sucesso!");
            showTab('xml-panel', document.querySelector('[onclick*="xml-panel"]'));
        }

        // --- MOTOR DE EXTRAÇÃO PGDAS PDF (V10.2 RESTAURADO) ---
        function handlePGDAS(f) {
            pgdasFiles = Array.from(f);
            document.getElementById('pgdas-label').innerText = `${f.length} PDFs selecionados`;
            document.getElementById('btn-pgdas').disabled = false;
        }

        async function processPGDAS() {
            const db = JSON.parse(localStorage.getItem('audit_pgdas_db')) || [];
            for(let file of pgdasFiles) {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(s => s.str).join(" ") + " ";
                }

                const cleanText = fullText.replace(/\s+/g, ' ');
                const cnpj = (cleanText.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/) || [""])[0];
                const period = cleanText.match(/Período de Apuração:\s*01\/(\d{2})\/(\d{4})/);
                const nome = (cleanText.match(/Nome empresarial:\s*(.*?)\s*Data/) || ["", "Não identificado"])[1];
                
                if(!period) continue;
                const ref = `${MESES[parseInt(period[1])-1]}/${period[2]}`;
                if(db.find(x => x.cnpj === cnpj && x.ref === ref)) continue;

                let atividades = [];
                const blocos = cleanText.split("Valor do Débito por Tributo para a Atividade");
                blocos.slice(1).forEach(b => {
                    const desc = b.match(/^(.*?)\s*Receita Bruta/);
                    const rec = b.match(/Receita Bruta Informada\s*:\s*R\$\s*([\d.]+,\d{2})/);
                    const impostos = b.match(/[\d.]+,\d{2}/g); // Pega os valores da tabela
                    if(impostos && impostos.length > 8) {
                        atividades.push({ 
                            label: desc ? desc[1].trim() : "Atividade", 
                            receita: rec ? rec[1] : "0,00",
                            total: impostos[8],
                            detalhe: impostos.slice(0, 6) // IRPJ, CSLL, PIS, COFINS, CPP, ICMS
                        });
                    }
                });

                db.push({
                    nome, cnpj, ref,
                    rbt12: (cleanText.match(/RBT12\)\s*[\d.,]+\s*[\d.,]+\s*([\d.]+,\d{2})/) || ["","0,00"])[1],
                    atividades,
                    dasTotal: (cleanText.match(/Valor Total do DAS:\s*([\d.]+,\d{2})/) || ["","0,00"])[1]
                });
            }
            localStorage.setItem('audit_pgdas_db', JSON.stringify(db));
            alert("PDFs Processados!");
            renderPGDASTable();
        }

        // --- RENDERIZAÇÃO ---
        function renderXMLTable() {
            const data = JSON.parse(localStorage.getItem('audit_xml_db')) || [];
            document.getElementById('xml-body').innerHTML = data.map(i => `
                <tr>
                    <td><b class='text-white uppercase'>${i.empresa}</b><br><small class='text-zinc-600'>${i.cnpj}</small></td>
                    <td class='text-orange-500 font-bold'>${i.ref}</td>
                    <td class='font-black'>${i.nNF}</td>
                    <td><button onclick="downloadCSV(${data.indexOf(i)})" class='text-[9px] bg-zinc-800 p-2 rounded uppercase'>Relatório</button></td>
                </tr>
            `).join('');
        }

        function renderPGDASTable() {
            const data = JSON.parse(localStorage.getItem('audit_pgdas_db')) || [];
            document.getElementById('pgdas-body').innerHTML = data.map(i => `
                <tr>
                    <td><b class='text-white uppercase'>${i.nome}</b><br><small>${i.cnpj} | ${i.ref}</small></td>
                    <td class='text-zinc-400'>R$ ${i.rbt12}</td>
                    <td>${i.atividades.map(a => `
                        <div class="activity-item">
                            <div class="font-black text-[9px] text-zinc-400 uppercase">${a.label}</div>
                            <div class="text-white text-[10px] font-bold">Receita: R$ ${a.receita}</div>
                            <div class="tax-grid">
                                <div class="tax-box"><label>IRPJ</label><span>${a.detalhe[0]}</span></div>
                                <div class="tax-box"><label>CSLL</label><span>${a.detalhe[1]}</span></div>
                                <div class="tax-box"><label>PIS</label><span>${a.detalhe[2]}</span></div>
                                <div class="tax-box"><label>COF</label><span>${a.detalhe[3]}</span></div>
                            </div>
                        </div>
                    `).join('')}</td>
                    <td class='text-orange-500 font-black text-sm'>R$ ${i.dasTotal}</td>
                </tr>
            `).join('');
        }

        window.onload = () => { renderXMLTable(); renderPGDASTable(); };
    </script>
</body>
</html>
