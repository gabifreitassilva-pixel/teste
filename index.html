<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - SISTEMA INTEGRADO V16 (FINAL)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--bg-dark); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .nav-group { margin-bottom: 10px; }
        .section-title { padding: 15px 25px 5px; font-size: 9px; font-weight: 900; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
        .nav-link { padding: 10px 25px; font-size: 11px; font-weight: 600; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--orange-main); background: rgba(249, 115, 22, 0.05); border-left-color: var(--orange-main); }
        .main-container { flex: 1; background: #050505; overflow-y: auto; padding: 30px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card-panel { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--orange-main); color: #000 !important; font-weight: 800; border-radius: 6px; padding: 10px 20px; text-transform: uppercase; font-size: 11px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-red { background: #dc2626; color: #fff !important; font-weight: 800; border-radius: 6px; padding: 10px 20px; text-transform: uppercase; font-size: 11px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .table-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #111; color: var(--orange-main); font-size: 10px; text-transform: uppercase; padding: 12px; text-align: left; font-weight: 800; border-bottom: 2px solid #222; }
        td { padding: 10px 12px; font-size: 11px; border-bottom: 1px solid #1a1a1a; color: #ccc; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #064e3b; color: #34d399; border: 1px solid #059669; }
        .badge-warn { background: #422006; color: #fdba74; border: 1px solid #c2410c; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-6 border-b border-zinc-900 mb-2 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
            <p class="text-[8px] text-zinc-600 font-bold uppercase tracking-[0.3em]">Auditoria Integrada</p>
        </div>
        <nav class="flex-1">
            <div class="nav-group"><div class="section-title">Extração</div><div class="nav-link active" onclick="showTab('extrator-panel', this)"><i class="fas fa-upload"></i> Módulo de Carga</div></div>
            <div class="nav-group"><div class="section-title">Consultas</div><div class="nav-link" onclick="showTab('xml-history-panel', this)"><i class="fas fa-file-code"></i> Histórico XML</div><div class="nav-link" onclick="showTab('pgdas-history-panel', this)"><i class="fas fa-file-invoice-dollar"></i> Histórico PGDAS</div></div>
            <div class="nav-group"><div class="section-title">Auditoria</div><div class="nav-link" onclick="showTab('auditor-panel', this)"><i class="fas fa-robot"></i> Auditor Inteligente</div><div class="nav-link" onclick="showTab('retificacao-panel', this)"><i class="fas fa-exclamation-triangle"></i> Painel de Retificações</div></div>
            <div class="nav-group"><div class="section-title">Gestão</div><div class="nav-link" onclick="showTab('global-history-panel', this)"><i class="fas fa-history"></i> Histórico Global</div></div>
        </nav>
    </aside>

    <main class="main-container">
        <div id="extrator-panel" class="tab-content active">
            <h2 class="text-2xl font-black italic text-white uppercase mb-6">Módulo de Carga</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload XML / ZIP</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('xml-input').click()">
                        <p id="label-xml" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="xml-input" multiple accept=".xml,.zip" class="hidden" onchange="handleXMLFiles(this.files)">
                    </div>
                    <button id="btn-run-xml" onclick="processarXML()" class="btn-orange mt-4 w-full justify-center" disabled>Processar Notas</button>
                </div>
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload PGDAS (PDF)</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('pgdas-input').click()">
                        <p id="label-pgdas" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="pgdas-input" multiple accept=".pdf" class="hidden" onchange="handlePGDASFiles(this.files)">
                    </div>
                    <button id="btn-run-pgdas" onclick="processarPGDAS()" class="btn-orange mt-4 w-full justify-center" disabled>Extrair Dados PGDAS</button>
                </div>
            </div>
        </div>

        <div id="pgdas-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Extratos PGDAS Analisados</h2>
                <button onclick="clearHistory('pgdas')" class="btn-red"><i class="fas fa-trash-alt"></i> Limpar Lista</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Empresa / CNPJ</th><th>Competência</th><th>Resumo de Receitas</th><th>Atividades / Tributos</th><th>Total DAS</th><th>Ações</th></tr></thead>
                    <tbody id="tbody-pgdas"></tbody>
                </table>
            </div>
        </div>

        <div id="xml-history-panel" class="tab-content"><h2 class="text-2xl font-black text-white">Histórico XML</h2><div class="table-container"><table><thead><tr><th>Empresa</th><th>Ref</th><th>Notas</th></tr></thead><tbody id="tbody-xml"></tbody></table></div></div>
        <div id="auditor-panel" class="tab-content"><h2 class="text-2xl font-black text-white">Auditor</h2></div>
        <div id="retificacao-panel" class="tab-content"><h2 class="text-2xl font-black text-white">Retificações</h2></div>
        <div id="global-history-panel" class="tab-content"><h2 class="text-2xl font-black text-white">Global</h2></div>
    </main>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const MONTHS_FULL = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        let pgdasFiles = [];

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
            if(id === 'pgdas-history-panel') renderPGDASHistory();
        }

        async function handlePGDASFiles(files) {
            pgdasFiles = Array.from(files);
            document.getElementById('label-pgdas').innerText = `${files.length} PDFs Selecionados`;
            document.getElementById('btn-run-pgdas').disabled = false;
        }

        async function processarPGDAS() {
            const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
            
            for(let file of pgdasFiles) {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(" ") + " ";
                }

                // 1. Extração de Identidade e Período (Destaque Vermelho)
                const cnpj = (fullText.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/) || [""])[0];
                const nome = (fullText.match(/Nome empresarial:\s*(.*?)\s*Data de abertura/i) || ["", "Empresa"])[1].trim();
                const dataRef = (fullText.match(/Período de Apuração:\s*([\d/]+)\s*a/i) || ["", ""])[1];
                
                let refExtenso = "N/A";
                if(dataRef) {
                    const parts = dataRef.split('/');
                    refExtenso = `${MONTHS_FULL[parseInt(parts[1])-1]} DE ${parts[2]}`;
                }

                // 2. Extração de Receitas (Competência e RBT12)
                const receitaPA = (fullText.match(/Receita Bruta do PA \(RPA\) Competência\s*([\d\.,]+)/i) || ["", "0,00"])[1];
                const rbt12 = (fullText.match(/Receita bruta acumulada nos doze meses anteriores ao PA \(RBT12\)\s*([\d\.,]+)/i) || ["", "0,00"])[1];

                // 3. Extração Dinâmica de Atividades e Tributos (Destaques Vermelhos das Atividades)
                const atividades = [];
                // Regex para capturar os blocos de tributos por atividade
                const ativRegex = /Valor do Débito por Tributo para a Atividade \(R\$\):\s*(.*?)\s*Receita Bruta Informada:\s*R\$\s*([\d\.,]+)\s*IRPJ.*?Total\s*([\d\.,\s]+)/gi;
                
                let m;
                while ((m = ativRegex.exec(fullText)) !== null) {
                    const descAtiv = m[1].trim();
                    const recAtiv = m[2];
                    const tributosRaw = m[3].trim().split(/\s+/).filter(v => v.includes(','));
                    
                    atividades.push({
                        descricao: descAtiv,
                        receita: recAtiv,
                        impostos: {
                            irpj: tributosRaw[0] || "0,00", csll: tributosRaw[1] || "0,00", cofins: tributosRaw[2] || "0,00",
                            pis: tributosRaw[3] || "0,00", cpp: tributosRaw[4] || "0,00", icms: tributosRaw[5] || "0,00",
                            ipi: tributosRaw[6] || "0,00", iss: tributosRaw[7] || "0,00", total: tributosRaw[8] || "0,00"
                        }
                    });
                }

                h.push({
                    empresa: nome, cnpj: cnpj, ref: refExtenso, 
                    receitaComp: receitaPA, rbt12: rbt12,
                    atividades: atividades,
                    totalDas: (fullText.match(/Valor Total do DAS:\s*R\$\s*([\d\.,]+)/i) || ["", "0,00"])[1]
                });
            }
            localStorage.setItem('pgdas_history', JSON.stringify(h));
            alert("PGDAS Processado com Sucesso!");
            renderPGDASHistory();
        }

        function renderPGDASHistory() {
            const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
            const tbody = document.getElementById('tbody-pgdas');
            tbody.innerHTML = h.map((item, idx) => `
                <tr class="hover:bg-zinc-900/50">
                    <td><div class="font-bold text-white">${item.empresa}</div><div class="text-[9px] text-zinc-600">${item.cnpj}</div></td>
                    <td><span class="badge badge-warn">${item.ref}</span></td>
                    <td><div class="text-[10px]"><b>PA:</b> R$ ${item.receitaComp}</div><div class="text-[10px] text-zinc-500"><b>RBT12:</b> R$ ${item.rbt12}</div></td>
                    <td>
                        <div class="flex flex-col gap-2">
                            ${item.atividades.map(at => `
                                <div class="p-2 bg-zinc-900 rounded border border-zinc-800 text-[9px]">
                                    <div class="text-orange-500 font-bold uppercase mb-1">${at.descricao}</div>
                                    <div class="text-white mb-1 font-bold">Receita: R$ ${at.receita}</div>
                                    <div class="grid grid-cols-3 gap-x-4 text-zinc-500 italic">
                                        <span>IRPJ: ${at.impostos.irpj}</span><span>CSLL: ${at.impostos.csll}</span><span>COF: ${at.impostos.cofins}</span>
                                        <span>PIS: ${at.impostos.pis}</span><span>CPP: ${at.impostos.cpp}</span><span>ICMS: ${at.impostos.icms}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                    <td class="font-black text-orange-500">R$ ${item.totalDas}</td>
                    <td><i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteHistory('pgdas', ${idx})"></i></td>
                </tr>
            `).join('');
        }

        function deleteHistory(type, idx) {
            const key = type === 'pgdas' ? 'pgdas_history' : 'xml_audit_history';
            const data = JSON.parse(localStorage.getItem(key));
            data.splice(idx, 1);
            localStorage.setItem(key, JSON.stringify(data));
            renderPGDASHistory();
        }

        function clearHistory(type) {
            if(confirm("Deseja limpar este histórico?")) {
                localStorage.removeItem(type === 'pgdas' ? 'pgdas_history' : 'xml_audit_history');
                renderPGDASHistory();
            }
        }
    </script>
</body>
</html>
