<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - SISTEMA INTEGRADO V17 (FINAL)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: var(--bg-dark); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .nav-group { margin-bottom: 10px; }
        .section-title { padding: 15px 25px 5px; font-size: 9px; font-weight: 900; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
        .nav-link { padding: 10px 25px; font-size: 11px; font-weight: 600; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--orange-main); background: rgba(249, 115, 22, 0.05); border-left-color: var(--orange-main); }
        .nav-link i { width: 15px; text-align: center; }
        
        /* Main Content */
        .main-container { flex: 1; background: #050505; overflow-y: auto; padding: 30px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Componentes UI */
        .card-panel { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--orange-main); color: #000 !important; font-weight: 800; border-radius: 6px; padding: 10px 20px; text-transform: uppercase; font-size: 11px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-orange:hover { filter: brightness(1.1); }
        .btn-orange:disabled { background: #333; color: #555 !important; cursor: not-allowed; }
        .btn-red { background: #dc2626; color: #fff !important; font-weight: 800; border-radius: 6px; padding: 10px 20px; text-transform: uppercase; font-size: 11px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-red:hover { background: #b91c1c; }

        /* Tabelas */
        .table-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #111; color: var(--orange-main); font-size: 10px; text-transform: uppercase; padding: 12px; text-align: left; font-weight: 800; border-bottom: 2px solid #222; }
        td { padding: 10px 12px; font-size: 11px; border-bottom: 1px solid #1a1a1a; color: #ccc; }
        tr:hover td { background: #0f0f0f; color: #fff; }

        /* Badges & Detalhes */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #064e3b; color: #34d399; border: 1px solid #059669; }
        .badge-warn { background: #422006; color: #fdba74; border: 1px solid #c2410c; }
        .pgdas-activity { background: #111; border: 1px solid #333; padding: 10px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid var(--orange-main); }
        .pgdas-header { font-size: 10px; color: #aaa; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .tax-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; text-align: center; }
        .tax-box { background: #222; padding: 4px; border-radius: 3px; }
        .tax-label { font-size: 7px; color: #888; display: block; }
        .tax-val { font-size: 9px; color: #fff; font-weight: bold; }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:50; display:none; justify-content:center; align-items:center; }
        .modal-content { background:#0a0a0a; width:80%; max-width:800px; max-height:90vh; overflow-y:auto; border:1px solid #333; border-radius:12px; padding:20px; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-6 border-b border-zinc-900 mb-2 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
            <p class="text-[8px] text-zinc-600 font-bold uppercase tracking-[0.3em]">Auditoria Integrada</p>
        </div>
        
        <nav class="flex-1">
            <div class="nav-group">
                <div class="section-title">Extração</div>
                <div class="nav-link active" onclick="showTab('extrator-panel', this)"><i class="fas fa-upload"></i> Módulo de Carga</div>
            </div>
            <div class="nav-group">
                <div class="section-title">Consultas</div>
                <div class="nav-link" onclick="showTab('xml-history-panel', this)"><i class="fas fa-file-code"></i> Histórico XML</div>
                <div class="nav-link" onclick="showTab('pgdas-history-panel', this)"><i class="fas fa-file-invoice-dollar"></i> Histórico PGDAS</div>
            </div>
            <div class="nav-group">
                <div class="section-title">Auditoria</div>
                <div class="nav-link" onclick="showTab('auditor-panel', this)"><i class="fas fa-robot"></i> Auditor Inteligente</div>
                <div class="nav-link" onclick="showTab('retificacao-panel', this)"><i class="fas fa-exclamation-triangle"></i> Painel de Retificações</div>
            </div>
            <div class="nav-group">
                <div class="section-title">Gestão</div>
                <div class="nav-link" onclick="showTab('global-history-panel', this)"><i class="fas fa-history"></i> Histórico Global</div>
                <div class="nav-link" onclick="showTab('consultoria-panel', this)"><i class="fas fa-save"></i> Gravar Consultoria</div>
            </div>
            <div class="nav-group">
                <div class="section-title">Legislação</div>
                <a href="BENEFICIOS ISENCOES E REDUCAO.HTML" target="_blank" class="nav-link"><i class="fas fa-book-open"></i> Benefícios ICMS (SP)</a>
                <a href="CONVÊNIO ICMS N° 142, DE 14 DE DEZEMBRO DE 2018.html" target="_blank" class="nav-link"><i class="fas fa-gavel"></i> Convênio 142/18 (ST)</a>
                <a href="PIS COFINS.HTML" target="_blank" class="nav-link"><i class="fas fa-balance-scale"></i> PIS/COFINS (Federal)</a>
            </div>
        </nav>
    </aside>

    <main class="main-container">
        
        <div id="extrator-panel" class="tab-content active">
            <h2 class="text-2xl font-black italic text-white uppercase mb-6">Módulo de Carga</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload XML / ZIP</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('xml-input').click()">
                        <p id="label-xml" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="xml-input" multiple accept=".xml,.zip" class="hidden" onchange="handleXMLFiles(this.files)">
                    </div>
                    <button id="btn-run-xml" onclick="processarXML()" class="btn-orange mt-4 w-full justify-center" disabled>Processar Notas</button>
                </div>
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload PGDAS (PDF)</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('pgdas-input').click()">
                        <p id="label-pgdas" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="pgdas-input" multiple accept=".pdf" class="hidden" onchange="handlePGDASFiles(this.files)">
                    </div>
                    <button id="btn-run-pgdas" onclick="processarPGDAS()" class="btn-orange mt-4 w-full justify-center" disabled>Extrair Dados</button>
                </div>
            </div>
        </div>

        <div id="xml-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Histórico XML</h2>
                <div class="flex gap-2">
                    <button onclick="clearHistory('xml')" class="btn-red"><i class="fas fa-trash-alt"></i> Limpar Tudo</button>
                    <button onclick="exportBatchByCNPJ()" class="btn-orange"><i class="fas fa-file-excel"></i> Relatório Excel (Tags)</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th width="40"><input type="checkbox" onclick="toggleChecks(this)"></th><th>Empresa / CNPJ</th><th>Competência</th><th>Arquivos/Itens</th><th>Ações</th></tr></thead>
                    <tbody id="tbody-xml"></tbody>
                </table>
            </div>
        </div>

        <div id="pgdas-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Extratos PGDAS</h2>
                <button onclick="clearHistory('pgdas')" class="btn-red"><i class="fas fa-trash-alt"></i> Limpar Tudo</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Empresa</th><th>Competência</th><th>Resumo Atividades</th><th>Ações</th></tr></thead>
                    <tbody id="tbody-pgdas"></tbody>
                </table>
            </div>
        </div>

        <div id="auditor-panel" class="tab-content">
            <h2 class="text-2xl font-black italic text-orange-500 mb-2">AUDITOR INTELIGENTE</h2>
            <div class="card-panel">
                <label class="text-[10px] uppercase font-bold text-zinc-400">Selecione a Empresa/Período:</label>
                <div class="flex gap-4 mt-2">
                    <select id="audit-selector" class="bg-black border border-zinc-800 text-white text-xs p-3 rounded w-full outline-none focus:border-orange-500"></select>
                    <button onclick="runAudit()" class="btn-orange whitespace-nowrap"><i class="fas fa-play"></i> Executar</button>
                </div>
            </div>
            <div id="audit-results" class="hidden">
                <p class="text-white mt-4">Auditoria realizada. Verifique o Painel de Retificações.</p>
            </div>
        </div>

        <div id="retificacao-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-red-500">PAINEL DE RETIFICAÇÕES</h2>
                <button onclick="saveConsultation()" class="btn-orange"><i class="fas fa-check-circle"></i> Salvar</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Status</th><th>Produto/NCM</th><th>Vl. Venda</th><th>CST Atual</th><th>Sugestão</th></tr></thead>
                    <tbody id="tbody-retificacao"></tbody>
                </table>
            </div>
        </div>

        <div id="global-history-panel" class="tab-content">
            <h2 class="text-2xl font-black italic text-white">Histórico Global</h2>
            <div class="table-container">
                <table>
                    <thead><tr><th>Data</th><th>Empresa</th><th>Ref</th><th>Recuperação</th><th>Status</th></tr></thead>
                    <tbody id="tbody-global"></tbody>
                </table>
            </div>
        </div>

        <div id="consultoria-panel" class="tab-content">
            </div>

    </main>

    <div id="modal-pgdas" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Detalhes do PGDAS</h3>
                <button onclick="document.getElementById('modal-pgdas').style.display='none'" class="text-red-500 font-bold">X</button>
            </div>
            <div id="modal-pgdas-body"></div>
        </div>
    </div>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const MONTHS_FULL = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        // Utils
        const formatMoney = (v) => parseFloat(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatCNPJ = (v) => v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, "$1.$2.$3/$4-$5");

        let xmlBuffer = [];
        let pgdasFiles = [];
        let currentAuditResults = [];

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
            if(id === 'xml-history-panel') renderXMLHistory();
            if(id === 'pgdas-history-panel') renderPGDASHistory();
            if(id === 'auditor-panel') populateAuditSelect();
            if(id === 'global-history-panel') renderGlobalHistory();
        }

        // --- XML PROCESSING ---
        async function handleXMLFiles(files) {
            xmlBuffer = [];
            const loadFile = async (f) => {
                if (f.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(f);
                    const promises = Object.keys(zip.files).filter(p => p.toLowerCase().endsWith('.xml')).map(p => zip.files[p].async("text"));
                    return Promise.all(promises);
                }
                return [await f.text()];
            };
            const results = await Promise.all(Array.from(files).map(loadFile));
            xmlBuffer = results.flat();
            document.getElementById('label-xml').innerText = `${xmlBuffer.length} Arquivos`;
            document.getElementById('btn-run-xml').disabled = false;
        }

        function extractTag(parent, tagName) {
            return parent.getElementsByTagName(tagName)[0]?.textContent || "";
        }

        function extractDate(ide) {
            // Tenta formatos dhEmi (YYYY-MM-DD...) e dEmi (YYYYMMDD)
            let d = extractTag(ide, "dhEmi");
            if(d) return d.substring(0, 10);
            
            d = extractTag(ide, "dEmi"); // Formato YYYYMMDD
            if(d && d.length === 8) return `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}`;
            
            return null;
        }

        function processarXML() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const groups = {};
            const parser = new DOMParser();

            xmlBuffer.forEach(text => {
                const xml = parser.parseFromString(text, "text/xml");
                const emit = xml.getElementsByTagName("emit")[0];
                const ide = xml.getElementsByTagName("ide")[0];
                if(!emit || !ide) return;

                const cnpjRaw = extractTag(emit, "CNPJ");
                const nome = extractTag(emit, "xNome");
                const dataIso = extractDate(ide);
                if(!dataIso) return;

                const [ano, mes, dia] = dataIso.split('-');
                const mesIdx = parseInt(mes) - 1;
                const ref = `${MONTHS_FULL[mesIdx]}/${ano}`;
                const key = `${cnpjRaw}_${ano}${mes}`;

                if(!groups[key]) {
                    groups[key] = {
                        key, 
                        empresa: nome, 
                        cnpjRaw, 
                        cnpj: formatCNPJ(cnpjRaw), 
                        ref, 
                        itens: []
                    };
                }

                const nNota = extractTag(ide, "nNF") || extractTag(ide, "nCFe") || "S/N";
                const dets = xml.getElementsByTagName("det");

                for(let i=0; i<dets.length; i++) {
                    const prod = dets[i].getElementsByTagName("prod")[0];
                    const imp = dets[i].getElementsByTagName("imposto")[0];
                    if(!prod) continue;

                    // Extração de Impostos (Percorre toda a árvore de imposto)
                    let csosn = "", cstPis = "", cstCofins = "";
                    
                    // Busca profunda por CSOSN ou CST dentro de ICMS
                    const icmsNode = imp.getElementsByTagName("ICMS")[0];
                    if(icmsNode) {
                        csosn = icmsNode.textContent.match(/<CSOSN>(\d+)<\/CSOSN>/)?.[1] || ""; // Hack regex simples se node traversal falhar
                        if(!csosn) {
                            // Tenta navegar
                            const children = icmsNode.children;
                            for(let j=0; j<children.length; j++) {
                                if(children[j].getElementsByTagName("CSOSN").length) csosn = extractTag(children[j], "CSOSN");
                                if(children[j].getElementsByTagName("CST").length) csosn = extractTag(children[j], "CST");
                            }
                        }
                    }

                    // PIS e COFINS
                    const pisNode = imp.getElementsByTagName("PIS")[0];
                    if(pisNode) {
                        const cstNode = pisNode.querySelector("CST");
                        if(cstNode) cstPis = cstNode.textContent;
                    }
                    const cofinsNode = imp.getElementsByTagName("COFINS")[0];
                    if(cofinsNode) {
                        const cstNode = cofinsNode.querySelector("CST");
                        if(cstCofins = cstNode) cstCofins = cstNode.textContent;
                    }

                    groups[key].itens.push({
                        Empresa: nome,
                        CNPJ: formatCNPJ(cnpjRaw),
                        Nota: nNota,
                        Data: `${dia}/${mes}/${ano}`,
                        MesAno: ref,
                        Prod: extractTag(prod, "xProd"),
                        NCM: extractTag(prod, "NCM"),
                        CFOP: extractTag(prod, "CFOP"),
                        Un: extractTag(prod, "uCom"),
                        Qtd: extractTag(prod, "qCom"),
                        vUn: extractTag(prod, "vUnCom"),
                        vTot: parseFloat(extractTag(prod, "vProd") || 0),
                        csosn, cstPis, cstCofins,
                        cst_atual: cstPis // Para auditoria
                    });
                }
            });

            Object.values(groups).forEach(g => {
                const idx = h.findIndex(x => x.key === g.key);
                if(idx >= 0) h[idx] = g;
                else h.push(g);
            });

            localStorage.setItem('xml_audit_history', JSON.stringify(h));
            alert("XMLs Processados!");
            document.getElementById('label-xml').innerText = "Selecionar Arquivos";
            document.getElementById('btn-run-xml').disabled = true;
            renderXMLHistory();
        }

        function renderXMLHistory() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            document.getElementById('tbody-xml').innerHTML = h.map((item, idx) => `
                <tr>
                    <td class="text-center"><input type="checkbox" class="xml-sel" data-idx="${idx}"></td>
                    <td><div class="font-bold text-white text-[11px]">${item.empresa}</div><div class="text-[9px] text-zinc-500">${item.cnpj}</div></td>
                    <td><span class="badge badge-warn text-[10px]">${item.ref}</span></td>
                    <td class="text-[11px]">${item.itens.length} itens</td>
                    <td>
                        <div class="flex gap-3">
                            <i class="fas fa-file-excel text-green-500 cursor-pointer" onclick="downloadCSV(${idx})" title="Baixar Excel"></i>
                            <i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteHistory('xml', ${idx})"></i>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function downloadCSV(idx) {
            const item = JSON.parse(localStorage.getItem('xml_audit_history'))[idx];
            generateAndDownloadCSV([item]);
        }

        function exportBatchByCNPJ() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const selectedIdx = Array.from(document.querySelectorAll('.xml-sel:checked')).map(cb => parseInt(cb.dataset.idx));
            if(!selectedIdx.length) return alert("Selecione os itens!");
            generateAndDownloadCSV(selectedIdx.map(i => h[i]));
        }

        function generateAndDownloadCSV(items) {
            let csv = "Empresa;CNPJ;Nota;Data;Mes/Ano;Produto;NCM;CFOP;Un;Qtd;Vl.Unit;Vl.Total;CSOSN/ICMS;CST_PIS;CST_COFINS\r\n";
            items.forEach(lote => {
                lote.itens.forEach(i => {
                    const vUn = parseFloat(i.vUn).toFixed(2).replace('.',',');
                    const vTot = i.vTot.toFixed(2).replace('.',',');
                    const qtd = parseFloat(i.Qtd).toFixed(2).replace('.',',');
                    csv += `${i.Empresa};${i.CNPJ};${i.Nota};${i.Data};${i.MesAno};${i.Prod};${i.NCM};${i.CFOP};${i.Un};${qtd};${vUn};${vTot};${i.csosn};${i.cstPis};${i.cstCofins}\r\n`;
                });
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `RELATORIO_FISCAL_${Date.now()}.csv`;
            link.click();
        }

        // --- PGDAS PROCESSING ---
        async function handlePGDASFiles(files) {
            pgdasFiles = Array.from(files);
            document.getElementById('label-pgdas').innerText = `${files.length} PDFs`;
            document.getElementById('btn-run-pgdas').disabled = false;
        }

        async function processarPGDAS() {
            const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
            
            for(let file of pgdasFiles) {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(" ");
                }

                // Identificação Cabeçalho
                const cnpj = (fullText.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/) || ["CNPJ N/A"])[0];
                const razao = (fullText.match(/Nome empresarial:\s*(.*?)\s*Data/) || ["", "EMPRESA"])[1];
                const periodoRaw = (fullText.match(/Período de Apuração:\s*(\d{2}\/\d{2}\/\d{4})/) || ["",""])[1]; // 01/11/2025
                
                let refExtenso = "N/A";
                if(periodoRaw) {
                    const [d, m, a] = periodoRaw.split('/');
                    refExtenso = `${MONTHS_FULL[parseInt(m)-1]}/${a}`;
                }

                // Extração de Atividades (Loop)
                const atividades = [];
                // Estratégia: Split pelo texto chave e parsear o que vem depois
                const parts = fullText.split("Valor do Débito por Tributo para a Atividade");
                
                // Ignora a parte 0 (antes do primeiro débito)
                for(let i=1; i<parts.length; i++) {
                    const part = parts[i];
                    
                    // Descrição: Está logo no início do bloco, antes de "Receita Bruta Informada"
                    const descMatch = part.split("Receita Bruta Informada")[0];
                    const descClean = descMatch.replace(/\(R\$\)\s*:/, '').trim();

                    // Receita
                    const recMatch = part.match(/Receita Bruta Informada.*?:.*?([\d\.,]+)/);
                    const receita = recMatch ? recMatch[1] : "0,00";

                    // Impostos (Tabela fixa: IRPJ, CSLL, COFINS, PIS, INSS, ICMS, IPI, ISS, Total)
                    // Procura sequencia de valores monetários
                    const taxRegex = /([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)\s+([\d\.,]+)/;
                    const taxM = part.match(taxRegex);
                    
                    if(taxM) {
                        atividades.push({
                            desc: descClean,
                            receita: receita,
                            impostos: {
                                irpj: taxM[1], csll: taxM[2], cofins: taxM[3], pis: taxM[4],
                                cpp: taxM[5], icms: taxM[6], ipi: taxM[7], iss: taxM[8], total: taxM[9]
                            }
                        });
                    }
                }

                h.push({ empresa: razao, cnpj, ref: refExtenso, atividades });
            }

            localStorage.setItem('pgdas_history', JSON.stringify(h));
            alert("PGDAS Processados!");
            renderPGDASHistory();
        }

        function renderPGDASHistory() {
            const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
            document.getElementById('tbody-pgdas').innerHTML = h.map((item, idx) => `
                <tr>
                    <td><div class="font-bold text-white text-[11px]">${item.empresa}</div><div class="text-[9px] text-zinc-500">${item.cnpj}</div></td>
                    <td><span class="badge badge-success">${item.ref}</span></td>
                    <td class="text-[10px] text-zinc-400">${item.atividades.length} Atividades encontradas</td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="viewPGDAS(${idx})" class="btn-orange text-[9px]"><i class="fas fa-file-pdf"></i> Ver Relatório</button>
                            <i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteHistory('pgdas', ${idx})"></i>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function viewPGDAS(idx) {
            const item = JSON.parse(localStorage.getItem('pgdas_history'))[idx];
            const modalBody = document.getElementById('modal-pgdas-body');
            
            let html = `
                <div class="mb-4 border-b border-zinc-800 pb-2">
                    <h2 class="text-white font-bold">${item.empresa}</h2>
                    <p class="text-orange-500 font-bold">${item.ref} - ${item.cnpj}</p>
                </div>
            `;

            item.atividades.forEach(ativ => {
                html += `
                    <div class="pgdas-activity">
                        <div class="pgdas-header">${ativ.desc}</div>
                        <div class="text-white text-xs mb-2">Receita: <span class="text-green-400 font-bold">R$ ${ativ.receita}</span></div>
                        <div class="tax-grid">
                            <div class="tax-box"><span class="tax-label">IRPJ</span><span class="tax-val">${ativ.impostos.irpj}</span></div>
                            <div class="tax-box"><span class="tax-label">CSLL</span><span class="tax-val">${ativ.impostos.csll}</span></div>
                            <div class="tax-box"><span class="tax-label">COFINS</span><span class="tax-val">${ativ.impostos.cofins}</span></div>
                            <div class="tax-box"><span class="tax-label">PIS</span><span class="tax-val">${ativ.impostos.pis}</span></div>
                            <div class="tax-box"><span class="tax-label">CPP</span><span class="tax-val">${ativ.impostos.cpp}</span></div>
                            <div class="tax-box"><span class="tax-label">ICMS</span><span class="tax-val">${ativ.impostos.icms}</span></div>
                            <div class="tax-box"><span class="tax-label">IPI</span><span class="tax-val">${ativ.impostos.ipi}</span></div>
                            <div class="tax-box"><span class="tax-label">ISS</span><span class="tax-val">${ativ.impostos.iss}</span></div>
                            <div class="tax-box bg-orange-900"><span class="tax-label text-white">TOTAL</span><span class="tax-val">${ativ.impostos.total}</span></div>
                        </div>
                    </div>
                `;
            });

            modalBody.innerHTML = html;
            document.getElementById('modal-pgdas').style.display = 'flex';
        }

        // --- UTILS ---
        function clearHistory(type) {
            const key = type === 'xml' ? 'xml_audit_history' : type === 'pgdas' ? 'pgdas_history' : 'global_audit_history';
            if(confirm("Limpar todo o histórico?")) {
                localStorage.removeItem(key);
                location.reload();
            }
        }

        function deleteHistory(type, idx) {
            const key = type === 'xml' ? 'xml_audit_history' : 'pgdas_history';
            const h = JSON.parse(localStorage.getItem(key));
            h.splice(idx, 1);
            localStorage.setItem(key, JSON.stringify(h));
            type === 'xml' ? renderXMLHistory() : renderPGDASHistory();
        }

        function toggleChecks(source) { document.querySelectorAll('.xml-sel').forEach(c => c.checked = source.checked); }

        // --- AUDITOR INTELIGENTE (MOCKED PARA DEMONSTRAÇÃO) ---
        function populateAuditSelect() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const sel = document.getElementById('audit-selector');
            sel.innerHTML = '<option value="">Selecione...</option>';
            h.forEach((item, idx) => {
                sel.innerHTML += `<option value="${idx}">${item.empresa} - ${item.ref}</option>`;
            });
        }

        function runAudit() {
            const idx = document.getElementById('audit-selector').value;
            if(idx === "") return;
            const data = JSON.parse(localStorage.getItem('xml_audit_history'))[idx];
            // Lógica de auditoria simplificada para exemplo
            const divergencias = data.itens.filter(i => (i.NCM.startsWith('22') || i.NCM.startsWith('40')) && i.cst_atual !== '04');
            renderRetificacaoTable(divergencias);
            currentAuditResults = { ...data, itens: divergencias, totalPotencial: divergencias.reduce((acc, i) => acc + (i.vTot * 0.0365), 0) };
            document.getElementById('audit-results').classList.remove('hidden');
        }

        function renderRetificacaoTable(items) {
            const tbody = document.getElementById('tbody-retificacao');
            tbody.innerHTML = items.map(i => `
                <tr>
                    <td><span class="badge badge-danger">ERRO</span></td>
                    <td>${i.Prod}<br><small class="text-orange-500">${i.NCM}</small></td>
                    <td>R$ ${i.vTot.toFixed(2)}</td>
                    <td class="text-red-500">${i.cst_atual || 'ND'}</td>
                    <td class="text-green-500">04 - Monofásico</td>
                </tr>
            `).join('');
        }

        function saveConsultation() {
            if(!currentAuditResults) return;
            const g = JSON.parse(localStorage.getItem('global_audit_history')) || [];
            g.push({
                data: new Date().toLocaleDateString(),
                empresa: currentAuditResults.empresa,
                ref: currentAuditResults.ref,
                valorRec: currentAuditResults.totalPotencial,
                status: 'Concluído'
            });
            localStorage.setItem('global_audit_history', JSON.stringify(g));
            alert("Salvo!");
            renderGlobalHistory();
        }

        function renderGlobalHistory() {
            const h = JSON.parse(localStorage.getItem('global_audit_history')) || [];
            document.getElementById('tbody-global').innerHTML = h.map(i => `<tr><td>${i.data}</td><td>${i.empresa}</td><td>${i.ref}</td><td>${formatMoney(i.valorRec)}</td><td>${i.status}</td></tr>`).join('');
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        renderXMLHistory();
    </script>
</body>
</html>
