<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Histórico de Extrações XML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #050505; color: #fff; font-family: 'Inter', sans-serif; padding: 30px; }
        table { width: 100%; border-collapse: collapse; background: #0a0a0a; border-radius: 8px; overflow: hidden; }
        th { background: #111; padding: 15px; text-align: left; color: #444; font-size: 10px; text-transform: uppercase; border-bottom: 2px solid #1a1a1a; }
        td { padding: 12px 15px; border-bottom: 1px solid #0d0d0d; font-size: 13px; }
        tr:hover td { background: #0f0f0f; }
        .btn-export { background: #f97316; color: #000; font-weight: 900; font-size: 10px; padding: 8px 15px; border-radius: 4px; text-transform: uppercase; }
    </style>
</head>
<body>

    <h2 class="text-2xl font-black italic uppercase mb-10">Histórico <span class="text-[#f97316]">XML</span></h2>

    <table>
        <thead>
            <tr>
                <th>Empresa / CNPJ</th>
                <th>Mês Extraído</th>
                <th>Qtd Notas</th>
                <th class="text-right">Ação</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela"></tbody>
    </table>

    <script>
        function carregar() {
            const corpo = document.getElementById('corpo-tabela');
            const dados = JSON.parse(localStorage.getItem('xml_export_history')) || [];

            if (dados.length === 0) {
                corpo.innerHTML = `<tr><td colspan="4" class="text-center py-20 opacity-20 font-black">NENHUMA EXTRAÇÃO SALVA.</td></tr>`;
                return;
            }

            corpo.innerHTML = dados.reverse().map((reg, i) => {
                const idxReal = dados.length - 1 - i;
                return `
                <tr>
                    <td>
                        <div class="font-bold uppercase">${reg.empresa}</div>
                        <div class="text-[10px] text-zinc-600 font-mono">${reg.cnpj}</div>
                    </td>
                    <td class="font-bold text-orange-500">${reg.mesFiscal}</td>
                    <td>${reg.totalNotas} Notas</td>
                    <td class="text-right">
                        <button onclick="reExportar(${idxReal})" class="btn-export">Exportar Planilha</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function reExportar(idx) {
            const dados = JSON.parse(localStorage.getItem('xml_export_history'));
            const reg = dados[idx];
            let csv = "\ufeffEmpresa;CNPJ;Mes;Nota;Produto;NCM;CFOP;Unidade;Qtd;Unitario;Total_Item;CST_PIS;CST_COFINS;CST_ICMS;Credito_Calculado\n";
            reg.itens.forEach(d => {
                csv += `${d.Empresa};${d.CNPJ};${d.Mes};${d.Nota};${d.Produto};${d.NCM};${d.CFOP};${d.Unidade};${d.Qtd};${d.Unitario};${d.Total_Item};${d.CST_PIS};${d.CST_COFINS};${d.CST_ICMS};${d.Credito_Calculado}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `RE_EXPORT_${reg.empresa}.csv`;
            link.click();
        }

        window.onload = carregar;
    </script>
</body>
</html>
