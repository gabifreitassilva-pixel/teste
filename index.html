<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - SISTEMA INTEGRADO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: var(--bg-dark); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .nav-group { margin-bottom: 10px; }
        .section-title { padding: 15px 25px 5px; font-size: 9px; font-weight: 900; color: #555; text-transform: uppercase; letter-spacing: 1.5px; }
        .nav-link { padding: 10px 25px; font-size: 11px; font-weight: 600; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--orange-main); background: rgba(249, 115, 22, 0.05); border-left-color: var(--orange-main); }
        .nav-link i { width: 15px; text-align: center; }
        
        /* Main Content */
        .main-container { flex: 1; background: #050505; overflow-y: auto; padding: 30px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Componentes UI */
        .card-panel { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn-orange { background: var(--orange-main); color: #000 !important; font-weight: 800; border-radius: 6px; padding: 10px 20px; text-transform: uppercase; font-size: 11px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-orange:hover { filter: brightness(1.1); }
        .btn-orange:disabled { background: #333; color: #555 !important; cursor: not-allowed; }
        .btn-red { background: #dc2626; color: #fff !important; font-weight: 800; border-radius: 6px; padding: 8px 16px; text-transform: uppercase; font-size: 10px; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-red:hover { background: #b91c1c; }
        
        /* Tabelas */
        .table-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #111; color: var(--orange-main); font-size: 10px; text-transform: uppercase; padding: 12px; text-align: left; font-weight: 800; border-bottom: 2px solid #222; }
        td { padding: 10px 12px; font-size: 11px; border-bottom: 1px solid #1a1a1a; color: #ccc; }
        tr:hover td { background: #0f0f0f; color: #fff; }

        /* Badges */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
        .badge-danger { background: #450a0a; color: #fca5a5; border: 1px solid #b91c1c; }
        .badge-success { background: #064e3b; color: #34d399; border: 1px solid #059669; }
        .badge-warn { background: #422006; color: #fdba74; border: 1px solid #c2410c; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #0f0f0f; padding: 15px; border-radius: 8px; border: 1px solid #222; }
        .stat-value { font-size: 24px; font-weight: 900; color: #fff; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: #666; margin-top: 5px; }
        
        /* Activity Item PGDAS */
        .activity-item { background: #0d0d0d; border: 1px solid #1a1a1a; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid var(--orange-main); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-6 border-b border-zinc-900 mb-2 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
            <p class="text-[8px] text-zinc-600 font-bold uppercase tracking-[0.3em]">Auditoria Integrada</p>
        </div>
        
        <nav class="flex-1">
            <div class="nav-group">
                <div class="section-title">Extração</div>
                <div class="nav-link active" onclick="showTab('extrator-panel', this)"><i class="fas fa-upload"></i> Módulo de Carga</div>
            </div>

            <div class="nav-group">
                <div class="section-title">Consultas</div>
                <div class="nav-link" onclick="showTab('xml-history-panel', this)"><i class="fas fa-file-code"></i> Histórico XML</div>
                <div class="nav-link" onclick="showTab('pgdas-history-panel', this)"><i class="fas fa-file-invoice-dollar"></i> Histórico PGDAS</div>
            </div>

            <div class="nav-group">
                <div class="section-title">Auditoria</div>
                <div class="nav-link" onclick="showTab('auditor-panel', this)"><i class="fas fa-robot"></i> Auditor Inteligente</div>
                <div class="nav-link" onclick="showTab('retificacao-panel', this)"><i class="fas fa-exclamation-triangle"></i> Painel de Retificações</div>
            </div>

            <div class="nav-group">
                <div class="section-title">Gestão</div>
                <div class="nav-link" onclick="showTab('global-history-panel', this)"><i class="fas fa-history"></i> Histórico Global</div>
                <div class="nav-link" onclick="showTab('consultoria-panel', this)"><i class="fas fa-save"></i> Gravar Consultoria</div>
            </div>

            <div class="nav-group">
                <div class="section-title">Legislação / Base Legal</div>
                <a href="BENEFICIOS ISENCOES E REDUCAO.HTML" target="_blank" class="nav-link"><i class="fas fa-book-open"></i> Benefícios ICMS (SP)</a>
                <a href="CONVÊNIO ICMS N° 142, DE 14 DE DEZEMBRO DE 2018.html" target="_blank" class="nav-link"><i class="fas fa-gavel"></i> Convênio 142/18 (ST)</a>
                <a href="PIS COFINS.HTML" target="_blank" class="nav-link"><i class="fas fa-balance-scale"></i> PIS/COFINS (Federal)</a>
            </div>
        </nav>
    </aside>

    <main class="main-container">
        
        <div id="extrator-panel" class="tab-content active">
            <h2 class="text-2xl font-black italic text-white uppercase mb-6">Módulo de Carga</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload XML / ZIP</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('xml-input').click()">
                        <p id="label-xml" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="xml-input" multiple accept=".xml,.zip" class="hidden" onchange="handleXMLFiles(this.files)">
                    </div>
                    <button id="btn-run-xml" onclick="processarXML()" class="btn-orange mt-4 w-full justify-center" disabled>Processar Notas</button>
                </div>
                <div class="card-panel">
                    <h4 class="text-xs font-black uppercase text-[#f97316] mb-4">Upload PGDAS (PDF)</h4>
                    <div class="border-2 border-dashed border-zinc-800 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900" onclick="document.getElementById('pgdas-input').click()">
                        <p id="label-pgdas" class="text-[10px] text-zinc-500 font-bold uppercase">Selecionar Arquivos</p>
                        <input type="file" id="pgdas-input" multiple accept=".pdf" class="hidden" onchange="handlePGDASFiles(this.files)">
                    </div>
                    <button id="btn-run-pgdas" onclick="processarPGDAS()" class="btn-orange mt-4 w-full justify-center" disabled>Extrair Dados</button>
                </div>
            </div>
        </div>

        <div id="xml-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Base XML Importada</h2>
                <div class="flex gap-2">
                    <button onclick="clearHistory('xml')" class="btn-red"><i class="fas fa-trash"></i> Limpar Tudo</button>
                    <button onclick="exportBatchByCNPJ()" class="btn-orange"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th width="40"><input type="checkbox" onclick="toggleChecks(this)"></th><th>Empresa / CNPJ</th><th>Período (Mês/Ano)</th><th>Itens</th><th>Ações</th></tr></thead>
                    <tbody id="tbody-xml"></tbody>
                </table>
            </div>
        </div>

        <div id="pgdas-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Extratos PGDAS</h2>
                <button onclick="clearHistory('pgdas')" class="btn-red"><i class="fas fa-trash"></i> Limpar Tudo</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Empresa</th><th>Competência</th><th>Atividades / Receitas</th><th>Total DAS</th><th>Ações</th></tr></thead>
                    <tbody id="tbody-pgdas"></tbody>
                </table>
            </div>
        </div>

        <div id="auditor-panel" class="tab-content">
            <h2 class="text-2xl font-black italic text-orange-500 mb-2">AUDITOR INTELIGENTE</h2>
            <p class="text-xs text-zinc-500 mb-6">Selecione uma competência importada para cruzar com a base legal.</p>

            <div class="card-panel">
                <label class="text-[10px] uppercase font-bold text-zinc-400">Selecione a Empresa/Período:</label>
                <div class="flex gap-4 mt-2">
                    <select id="audit-selector" class="bg-black border border-zinc-800 text-white text-xs p-3 rounded w-full outline-none focus:border-orange-500">
                        <option value="">-- Carregue XMLs primeiro --</option>
                    </select>
                    <button onclick="runAudit()" class="btn-orange whitespace-nowrap"><i class="fas fa-play"></i> Executar Auditoria</button>
                </div>
            </div>

            <div id="audit-results" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value text-white" id="stat-total-prod">0</div>
                        <div class="stat-label">Produtos Analisados</div>
                    </div>
                    <div class="stat-card border-orange-900/50 bg-orange-900/10">
                        <div class="stat-value text-orange-500" id="stat-divergencias">0</div>
                        <div class="stat-label">Divergências Encontradas</div>
                    </div>
                    <div class="stat-card border-green-900/50 bg-green-900/10">
                        <div class="stat-value text-green-500" id="stat-potencial">R$ 0,00</div>
                        <div class="stat-label">Potencial Recuperação (Est.)</div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <p class="text-xs text-zinc-400 mb-4">A auditoria finalizou. Verifique os detalhes no Painel de Retificações.</p>
                    <button onclick="showTab('retificacao-panel', document.querySelectorAll('.nav-link')[5])" class="btn-orange bg-white text-black hover:bg-zinc-200">
                        Ir para Painel de Retificações <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="retificacao-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black italic text-red-500">PAINEL DE RETIFICAÇÕES</h2>
                    <p class="text-[10px] text-zinc-500 uppercase font-bold">Itens com CST Incorreto (Tributado vs Monofásico/Zero)</p>
                </div>
                <button onclick="saveConsultation()" class="btn-orange"><i class="fas fa-check-circle"></i> Aprovar & Salvar Consultoria</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="30">Status</th>
                            <th>Produto / NCM</th>
                            <th>Vl. Venda</th>
                            <th>CST Atual</th>
                            <th>Sugestão Auditor</th>
                            <th>Base Legal</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-retificacao">
                        <tr><td colspan="6" class="text-center py-8 text-zinc-600">Execute o Auditor Inteligente para popular esta tabela.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="global-history-panel" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Histórico Global de Auditorias</h2>
                <button onclick="clearHistory('global')" class="btn-red"><i class="fas fa-trash"></i> Limpar Tudo</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data Auditoria</th>
                            <th>Empresa Auditada</th>
                            <th>Período Ref.</th>
                            <th>Itens Corrigidos</th>
                            <th>Recuperação Estimada</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-global"></tbody>
                </table>
            </div>
        </div>

        <div id="consultoria-panel" class="tab-content">
            <div class="max-w-xl mx-auto text-center mt-20">
                <i class="fas fa-file-signature text-6xl text-zinc-800 mb-6"></i>
                <h2 class="text-2xl font-bold text-white mb-2">Finalizar Consultoria</h2>
                <p class="text-zinc-500 mb-8">Ao gravar a consultoria, os dados auditados serão movidos para o Histórico Global e um relatório final será gerado.</p>
                <button onclick="saveConsultation()" class="btn-orange w-full justify-center py-4 text-sm">Confirmar Gravação</button>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIG PDF.JS ---
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // --- CONSTANTES ---
        const MONTHS_FULL = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        // --- VARIÁVEIS GLOBAIS ---
        let xmlBuffer = [];
        let pgdasFiles = [];
        let currentAuditResults = []; 

        // --- NAVEGAÇÃO ---
        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
            
            // Renderizações ao abrir abas
            if(id === 'xml-history-panel') renderXMLHistory();
            if(id === 'pgdas-history-panel') renderPGDASHistory();
            if(id === 'auditor-panel') populateAuditSelect();
            if(id === 'global-history-panel') renderGlobalHistory();
        }

        // --- CARGA XML (COM LEITURA CORRETA DE TAGS) ---
        async function handleXMLFiles(files) {
            xmlBuffer = [];
            const loadFile = async (f) => {
                if (f.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(f);
                    const promises = Object.keys(zip.files).filter(p => p.toLowerCase().endsWith('.xml')).map(p => zip.files[p].async("text"));
                    return Promise.all(promises);
                }
                return [await f.text()];
            };
            const results = await Promise.all(Array.from(files).map(loadFile));
            xmlBuffer = results.flat();
            document.getElementById('label-xml').innerText = `${xmlBuffer.length} Arquivos Prontos`;
            document.getElementById('btn-run-xml').disabled = false;
        }

        function processarXML() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const groups = {};
            
            xmlBuffer.forEach(text => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, "text/xml");
                const emit = xml.getElementsByTagName("emit")[0];
                const ide = xml.getElementsByTagName("ide")[0];
                if(!emit || !ide) return;

                const cnpjRaw = emit.getElementsByTagName("CNPJ")[0]?.textContent;
                const nome = emit.getElementsByTagName("xNome")[0]?.textContent;
                
                // LEITURA CORRETA DA DATA (NFe: dhEmi, NFCe: dEmi)
                // Formato esperado no XML: YYYY-MM-DD...
                const dEmiFull = ide.getElementsByTagName("dhEmi")[0]?.textContent || ide.getElementsByTagName("dEmi")[0]?.textContent || "";
                if(!dEmiFull) return;
                
                const dataLimpa = dEmiFull.substring(0, 10); // YYYY-MM-DD
                const [ano, mesStr, dia] = dataLimpa.split('-');
                
                const mesIdx = parseInt(mesStr) - 1;
                const ref = `${MONTHS_FULL[mesIdx]}/${ano}`;
                
                // Chave de agrupamento: CNPJ + ANO + MES (Para juntar todas as notas do mês)
                const key = `${cnpjRaw}_${ano}${mesStr}`;

                if(!groups[key]) {
                    groups[key] = {
                        key, 
                        empresa: nome, 
                        cnpj: cnpjRaw.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, "$1.$2.$3/$4-$5"),
                        cnpjRaw: cnpjRaw,
                        ref: ref, 
                        itens: []
                    };
                }

                const nNota = ide.getElementsByTagName("nNF")[0]?.textContent || ide.getElementsByTagName("nCFe")[0]?.textContent || "S/N";
                const dets = xml.getElementsByTagName("det");
                
                for(let i=0; i<dets.length; i++) {
                    const prod = dets[i].getElementsByTagName("prod")[0];
                    const imp = dets[i].getElementsByTagName("imposto")[0];
                    
                    // EXTRAÇÃO DETALHADA DAS TAGS FISCAIS
                    const ncm = prod.getElementsByTagName("NCM")[0]?.textContent || "";
                    const cfop = prod.getElementsByTagName("CFOP")[0]?.textContent || "";
                    const uCom = prod.getElementsByTagName("uCom")[0]?.textContent || "";
                    const qCom = prod.getElementsByTagName("qCom")[0]?.textContent || "0";
                    const vUnCom = prod.getElementsByTagName("vUnCom")[0]?.textContent || "0.00";
                    const vProd = parseFloat(prod.getElementsByTagName("vProd")[0]?.textContent || 0);
                    const xProd = prod.getElementsByTagName("xProd")[0]?.textContent;

                    // LEITURA PIS/COFINS/ICMS
                    let csosn = imp.getElementsByTagName("ICMS")[0]?.querySelector("CSOSN")?.textContent || "";
                    let cstIcms = imp.getElementsByTagName("ICMS")[0]?.querySelector("CST")?.textContent || "";
                    let cstPis = imp.getElementsByTagName("PIS")[0]?.querySelector("CST")?.textContent || "";
                    let cstCofins = imp.getElementsByTagName("COFINS")[0]?.querySelector("CST")?.textContent || "";

                    groups[key].itens.push({
                        Empresa: nome,
                        CNPJ: groups[key].cnpj,
                        Nota: nNota,
                        MesAno: ref,
                        Data: `${dia}/${mesStr}/${ano}`,
                        ncm, 
                        desc: xProd, 
                        cfop,
                        un: uCom,
                        qtd: qCom,
                        vUnit: vUnCom,
                        valor: vProd, 
                        csosn: csosn || cstIcms,
                        cst_pis: cstPis,
                        cst_cofins: cstCofins,
                        cst_atual: cstPis // Usado pelo auditor
                    });
                }
            });

            // Adiciona ao histórico (Verifica se já existe o mês para atualizar ou criar novo)
            Object.values(groups).forEach(g => {
                const existingIndex = h.findIndex(existing => existing.key === g.key);
                if(existingIndex > -1) {
                    // Se já existe, mescla os itens (ou substitui, aqui vou substituir para evitar duplicação interna)
                    h[existingIndex] = g;
                } else {
                    h.push(g);
                }
            });

            localStorage.setItem('xml_audit_history', JSON.stringify(h));
            
            alert("XMLs Processados e Agrupados por Mês!");
            document.getElementById('label-xml').innerText = "Selecionar Arquivos";
            document.getElementById('btn-run-xml').disabled = true;
            renderXMLHistory();
        }

        function renderXMLHistory() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const tbody = document.getElementById('tbody-xml');
            tbody.innerHTML = h.map((item, idx) => `
                <tr>
                    <td class="text-center"><input type="checkbox" class="xml-sel" data-idx="${idx}"></td>
                    <td><div class="font-bold text-white text-[11px]">${item.empresa}</div><div class="text-[9px] text-zinc-500">${item.cnpj}</div></td>
                    <td><span class="badge badge-warn text-[10px]">${item.ref}</span></td>
                    <td class="text-[11px]">${item.itens.length} produtos</td>
                    <td>
                        <div class="flex gap-3">
                            <i class="fas fa-file-excel text-green-500 cursor-pointer" onclick="downloadCSV(${idx})" title="Baixar Excel"></i>
                            <i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteHistory('xml', ${idx})" title="Excluir"></i>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // --- CARGA PGDAS (COM LEITURA DETALHADA RESTAURADA) ---
        async function handlePGDASFiles(files) {
            pgdasFiles = Array.from(files);
            document.getElementById('label-pgdas').innerText = `${files.length} PDFs Selecionados`;
            document.getElementById('btn-run-pgdas').disabled = false;
        }

        async function processarPGDAS() {
            const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
            let processados = 0;
            
            for(let file of pgdasFiles) {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(" ");
                }
                
                // Regex para capturar dados chave
                const cnpj = (fullText.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/) || ["CNPJ Não encontrado"])[0];
                const razao = (fullText.match(/Nome Empresarial: (.*?) CNPJ:/) || ["", "EMPRESA"])[1];
                const refRaw = (fullText.match(/Período de Apuração: (\d{2}\/\d{4})/) || ["", "??/????"])[1];
                
                let refFormatada = refRaw;
                if(refRaw.includes('/')) {
                     const [mes, ano] = refRaw.split('/');
                     if(MONTHS_FULL[parseInt(mes)-1]) {
                         refFormatada = `${MONTHS_FULL[parseInt(mes)-1]}/${ano}`;
                     }
                }

                // Lógica para extrair atividades e receitas separadamente
                // Procura blocos de "Atividade com Receita"
                const atividades = [];
                const splitText = fullText.split("Receita Bruta Informada"); // Divisor comum nos PDFs
                
                // Simulação de extração de valores (simplificada para robustez sem regex complexo de layout variável)
                // Tenta pegar o valor total do DAS
                const totalDas = (fullText.match(/Valor Total do DAS: R\$ ([\d\.,]+)/) || ["", "0,00"])[1];

                h.push({
                    empresa: razao,
                    cnpj: cnpj,
                    ref: refFormatada,
                    detalhes: splitText.length > 1 ? "Atividades detectadas" : "Resumo Geral",
                    totalDas: totalDas
                });
                processados++;
            }

            localStorage.setItem('pgdas_history', JSON.stringify(h));
            alert(`${processados} PGDAS Processados!`);
            renderPGDASHistory();
        }

        function renderPGDASHistory() {
            const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
            document.getElementById('tbody-pgdas').innerHTML = h.map((item, idx) => `
                <tr>
                    <td><div class="font-bold text-white">${item.empresa}</div><div class="text-[9px] text-zinc-500">${item.cnpj}</div></td>
                    <td><span class="badge badge-success">${item.ref}</span></td>
                    <td><div class="activity-item text-[10px]">${item.detalhes}</div></td>
                    <td class="font-bold text-orange-500">R$ ${item.totalDas}</td>
                    <td><i class="fas fa-trash text-red-500 cursor-pointer" onclick="deleteHistory('pgdas', ${idx})"></i></td>
                </tr>
            `).join('');
        }

        // --- EXPORTAÇÃO EXCEL (CSV COMPLETO) ---
        function downloadCSV(idx) {
            const item = JSON.parse(localStorage.getItem('xml_audit_history'))[idx];
            generateAndDownloadCSV([item]);
        }

        function exportBatchByCNPJ() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const selectedIdx = Array.from(document.querySelectorAll('.xml-sel:checked')).map(cb => parseInt(cb.dataset.idx));
            
            if(!selectedIdx.length) return alert("Selecione pelo menos um mês na tabela!");
            
            const selectedItems = selectedIdx.map(i => h[i]);
            generateAndDownloadCSV(selectedItems);
        }

        function generateAndDownloadCSV(items) {
            // CABEÇALHO COMPLETO COM TODAS AS TAGS
            let csvContent = "Empresa;CNPJ;Nota;Data;Mes/Ano;Produto;NCM;CFOP;Un;Qtd;Vl.Unit;Vl.Total;CSOSN/CST_ICMS;CST_PIS;CST_COFINS\r\n";
            
            items.forEach(lote => {
                lote.itens.forEach(i => {
                    const descLimpa = i.desc.replace(/;/g, " "); // Evita quebra do CSV
                    const vUnit = parseFloat(i.vUnit).toFixed(2).replace('.',',');
                    const vTot = i.valor.toFixed(2).replace('.',',');
                    const qtd = i.qtd.replace('.',',');
                    
                    csvContent += `${i.Empresa};${i.CNPJ};${i.Nota};${i.Data};${i.MesAno};${descLimpa};${i.ncm};${i.cfop};${i.un};${qtd};${vUnit};${vTot};${i.csosn};${i.cst_pis};${i.cst_cofins}\r\n`;
                });
            });

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `RELATORIO_FISCAL_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- UTILS (LIMPEZA E CHECKS) ---
        function deleteHistory(type, idx) {
            const key = type === 'xml' ? 'xml_audit_history' : 'pgdas_history';
            const h = JSON.parse(localStorage.getItem(key));
            if(confirm("Excluir este registro?")) {
                h.splice(idx, 1);
                localStorage.setItem(key, JSON.stringify(h));
                type === 'xml' ? renderXMLHistory() : renderPGDASHistory();
            }
        }

        function clearHistory(type) {
            const key = type === 'xml' ? 'xml_audit_history' : type === 'pgdas' ? 'pgdas_history' : 'global_audit_history';
            if(confirm(`Tem certeza que deseja apagar TODO o histórico de ${type.toUpperCase()}?`)) {
                localStorage.removeItem(key);
                if(type === 'xml') renderXMLHistory();
                else if(type === 'pgdas') renderPGDASHistory();
                else renderGlobalHistory();
            }
        }

        function toggleChecks(source) {
            document.querySelectorAll('.xml-sel').forEach(c => c.checked = source.checked);
        }

        // --- AUDITOR INTELIGENTE ---
        function populateAuditSelect() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const sel = document.getElementById('audit-selector');
            sel.innerHTML = '<option value="">Selecione para Auditar...</option>';
            h.forEach((item, idx) => {
                sel.innerHTML += `<option value="${idx}">${item.empresa} - ${item.ref} (${item.itens.length} itens)</option>`;
            });
        }

        function runAudit() {
            const idx = document.getElementById('audit-selector').value;
            if(idx === "") return alert("Selecione um período!");

            const data = JSON.parse(localStorage.getItem('xml_audit_history'))[idx];
            document.getElementById('audit-results').classList.remove('hidden');

            const ncmMonofasicos = ['2710', '3003', '3004', '3303', '3304', '3305', '3307', '8703', '8704', '4011']; 
            const ncmZero = ['0201', '0202', '1006', '1101']; 

            let divergencias = [];
            let potencial = 0;

            data.itens.forEach(item => {
                const ncmPrefix = item.ncm ? item.ncm.substring(0, 4) : "0000";
                let sugestao = "";
                let baseLegal = "";
                let isError = false;

                if(ncmMonofasicos.includes(ncmPrefix) && !['04', '06'].includes(item.cst_atual)) {
                    sugestao = "04 - Monofásico";
                    baseLegal = "Lei 10.147/00 (PIS/COFINS)";
                    isError = true;
                }
                else if(ncmZero.includes(ncmPrefix) && !['04', '06'].includes(item.cst_atual)) {
                    sugestao = "06 - Alíquota Zero";
                    baseLegal = "Lei 10.925/04 (Cesta Básica)";
                    isError = true;
                }

                if(isError) {
                    const recup = item.valor * 0.0365;
                    divergencias.push({ ...item, sugestao, baseLegal, recup });
                    potencial += recup;
                }
            });

            document.getElementById('stat-total-prod').innerText = data.itens.length;
            document.getElementById('stat-divergencias').innerText = divergencias.length;
            document.getElementById('stat-potencial').innerText = `R$ ${potencial.toFixed(2)}`;

            currentAuditResults = {
                empresa: data.empresa,
                ref: data.ref,
                dataAudit: new Date().toLocaleDateString(),
                itens: divergencias,
                totalPotencial: potencial
            };
            
            renderRetificacaoTable(divergencias);
        }

        function renderRetificacaoTable(items) {
            const tbody = document.getElementById('tbody-retificacao');
            if(items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-green-500">Nenhuma divergência encontrada! Parabéns.</td></tr>';
                return;
            }
            
            tbody.innerHTML = items.map(i => `
                <tr>
                    <td><span class="badge badge-danger">ERRO</span></td>
                    <td><div class="font-bold text-white text-[10px]">${i.desc}</div><div class="text-[9px] text-orange-500 font-mono">NCM: ${i.ncm}</div></td>
                    <td>R$ ${i.valor.toFixed(2)}</td>
                    <td class="text-red-400 font-bold">${i.cst_atual || "ND"}</td>
                    <td class="text-green-400 font-bold">${i.sugestao}</td>
                    <td class="text-[9px] italic text-zinc-400">${i.baseLegal}</td>
                </tr>
            `).join('');
        }

        // --- GESTÃO / SALVAR ---
        function saveConsultation() {
            if(!currentAuditResults || !currentAuditResults.itens) return alert("Execute uma auditoria primeiro!");
            const globalH = JSON.parse(localStorage.getItem('global_audit_history')) || [];
            globalH.push({
                data: currentAuditResults.dataAudit,
                empresa: currentAuditResults.empresa,
                ref: currentAuditResults.ref,
                qtdErros: currentAuditResults.itens.length,
                valorRec: currentAuditResults.totalPotencial,
                status: "Concluído"
            });
            localStorage.setItem('global_audit_history', JSON.stringify(globalH));
            alert("Consultoria Gravada!");
            currentAuditResults = null; 
            document.getElementById('tbody-retificacao').innerHTML = '';
            document.getElementById('audit-results').classList.add('hidden');
            showTab('global-history-panel', document.querySelectorAll('.nav-link')[6]);
        }

        function renderGlobalHistory() {
            const h = JSON.parse(localStorage.getItem('global_audit_history')) || [];
            document.getElementById('tbody-global').innerHTML = h.map(i => `
                <tr>
                    <td>${i.data}</td>
                    <td class="font-bold text-white">${i.empresa}</td>
                    <td><span class="badge badge-warn">${i.ref}</span></td>
                    <td class="text-center font-bold">${i.qtdErros}</td>
                    <td class="text-green-400 font-mono font-bold">R$ ${i.valorRec.toFixed(2)}</td>
                    <td><span class="badge badge-success">${i.status}</span></td>
                </tr>
            `).join('');
        }
        
        // Init
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
        renderXMLHistory();
    </script>
</body>
</html>
