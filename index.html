<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FISCAL AUDIT - V11.9 MASTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #000000; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--bg-dark); border-right: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .nav-link { padding: 10px 25px; font-size: 10px; font-weight: 700; color: #888; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-transform: uppercase; border-left: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: var(--orange-main); background: #080808; border-left-color: var(--orange-main); }
        .section-title { padding: 20px 25px 8px; font-size: 9px; font-weight: 900; color: #444; text-transform: uppercase; letter-spacing: 2px; }
        .main-container { flex: 1; background: #050505; overflow-y: auto; }
        .tab-content { display: none; padding: 40px; }
        .tab-content.active { display: block; }
        .table-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #080808; color: var(--orange-main); font-size: 10px; text-transform: uppercase; padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        td { padding: 12px 15px; font-size: 11px; border-bottom: 1px solid #111; color: #ccc; }
        .btn-orange { background: var(--orange-main); color: #000; font-weight: 900; border-radius: 8px; padding: 12px; text-transform: uppercase; font-size: 11px; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .activity-item { background: #0d0d0d; border: 1px solid #1a1a1a; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 3px solid var(--orange-main); }
        .tax-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 8px; }
        .tax-unit { font-size: 9px; display: flex; flex-direction: column; }
        .tax-unit span:first-child { color: #555; font-weight: 800; font-size: 8px; }
        .tax-unit span:last-child { color: #f97316; font-weight: 600; }
        
        /* Estilo do Botão de Excluir */
        .btn-delete { color: #ef4444; transition: 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 6px; }
        .btn-delete:hover { background: rgba(239, 68, 68, 0.1); color: #f87171; transform: scale(1.1); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 border-b border-zinc-900 mb-2 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter text-white">FISCAL<span class="text-[#f97316]">AUDIT</span></h1>
            <p class="text-[8px] text-zinc-600 font-bold uppercase tracking-[0.3em]">V11.9 MASTER</p>
        </div>
        <nav>
            <div class="section-title">Extração</div>
            <div class="nav-link active" onclick="showTab('extrator-panel', this)"><i class="fas fa-upload"></i> Módulo de Carga</div>
            <div class="section-title">Consultas</div>
            <div class="nav-link" onclick="showTab('xml-history-panel', this)"><i class="fas fa-file-code"></i> Histórico XML</div>
            <div class="nav-link" onclick="showTab('pgdas-history-panel', this)"><i class="fas fa-file-invoice-dollar"></i> Histórico PGDAS</div>
            <div class="section-title">Auditoria</div>
            <div class="nav-link" onclick="showTab('cross-panel', this)"><i class="fas fa-sync"></i> Cruzar Informações</div>
            <div class="section-title">Legislação</div>
            <div class="nav-link" onclick="showTab('leg-state', this)"><i class="fas fa-map-marker-alt"></i> Estadual</div>
            <div class="nav-link" onclick="showTab('leg-fed', this)"><i class="fas fa-flag"></i> Federal</div>
        </nav>
    </aside>

    <main class="main-container">
        <div id="extrator-panel" class="tab-content active">
            <header class="mb-10"><h2 class="text-2xl font-black italic text-white">Central de <span class="text-[#f97316]">Carga</span></h2></header>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-[#0a0a0a] p-6 rounded-xl border border-zinc-900">
                    <h4 class="text-[10px] font-black uppercase text-[#f97316] mb-4">Carga XML / ZIP</h4>
                    <div class="border-2 border-dashed border-zinc-900 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900/30" onclick="document.getElementById('xml-input').click()">
                        <p id="label-xml" class="text-[9px] text-zinc-500 font-bold uppercase">Carregar arquivos</p>
                        <input type="file" id="xml-input" multiple accept=".xml,.zip" class="hidden" onchange="handleXMLFiles(this.files)">
                    </div>
                    <button id="btn-run-xml" onclick="processarXML()" class="btn-orange mt-4" disabled>Gravar no Histórico</button>
                </div>
                <div class="bg-[#0a0a0a] p-6 rounded-xl border border-zinc-900">
                    <h4 class="text-[10px] font-black uppercase text-[#f97316] mb-4">Carga PGDAS (PDF)</h4>
                    <div class="border-2 border-dashed border-zinc-900 rounded-xl p-8 text-center cursor-pointer hover:bg-zinc-900/30" onclick="document.getElementById('pgdas-input').click()">
                        <p id="label-pgdas" class="text-[9px] text-zinc-500 font-bold uppercase">Upload PDFs em Lote</p>
                        <input type="file" id="pgdas-input" multiple accept=".pdf" class="hidden" onchange="handlePGDASFiles(this.files)">
                    </div>
                    <button id="btn-run-pgdas" onclick="processarPGDAS()" class="btn-orange mt-4" disabled>Gravar PGDAS</button>
                </div>
            </div>
        </div>

        <div id="xml-history-panel" class="tab-content">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Histórico XML</h2>
                <div class="flex gap-2">
                    <button onclick="clearFullHistory('xml')" class="bg-red-900/20 text-red-500 border border-red-900/50 px-4 py-2 rounded-lg text-[9px] font-black uppercase hover:bg-red-500 hover:text-white transition">Limpar Histórico</button>
                    <button onclick="exportBatchXML()" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-[10px] font-black uppercase hover:bg-blue-500">Exportar Lote por CNPJ</button>
                </div>
            </header>
            <div class="table-container"><table><thead><tr><th width="40"><input type="checkbox" onclick="toggleChecks(this)"></th><th>Empresa</th><th>Ref</th><th>Qtd Nota</th><th width="120">Ações</th></tr></thead><tbody id="tbody-xml"></tbody></table></div>
        </div>

        <div id="pgdas-history-panel" class="tab-content">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic text-white">Histórico PGDAS</h2>
                <button onclick="clearFullHistory('pgdas')" class="bg-red-900/20 text-red-500 border border-red-900/50 px-4 py-2 rounded-lg text-[9px] font-black uppercase hover:bg-red-500 hover:text-white transition">Limpar Histórico</button>
            </header>
            <div class="table-container"><table><thead><tr><th width="20%">Razão Social</th><th width="10%">RBT12</th><th width="55%">Atividades</th><th width="10%">Total DAS</th><th width="50">Excluir</th></tr></thead><tbody id="tbody-pgdas"></tbody></table></div>
        </div>

        <div id="leg-state" class="tab-content"> ... </div>
        <div id="leg-fed" class="tab-content"> ... </div>
        <div id="cross-panel" class="tab-content"> ... </div>
    </main>

    <script>
        // ... TODAS AS FUNÇÕES DE EXTRAÇÃO XML E PGDAS MANTIDAS INTEGRALMENTE ...

        // RENDERIZAÇÃO XML COM BOTÃO DE EXCLUIR
        function renderXMLHistory() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            document.getElementById('tbody-xml').innerHTML = h.map((it, i) => `
                <tr class="hover:bg-zinc-900/50 transition">
                    <td><input type="checkbox" class="xml-sel" data-idx="${i}"></td>
                    <td><b class="text-white uppercase text-[10px]">${it.empresa}</b><br><small class="text-zinc-500">${it.cnpj}</small></td>
                    <td class="text-orange-500 font-bold">${it.ref}</td>
                    <td class="text-white font-black">${it.qtd}</td>
                    <td>
                        <div class="flex items-center gap-3">
                            <button onclick="downloadOneXML(${i})" class="bg-zinc-800 text-white px-3 py-1 rounded text-[9px] uppercase hover:bg-zinc-700">Planilha</button>
                            <i class="fas fa-trash-alt btn-delete" onclick="deleteEntry('xml', ${i})" title="Excluir Período"></i>
                        </div>
                    </td>
                </tr>`).join('') || '<tr><td colspan="5" class="text-center py-20 opacity-30 italic">Nenhum XML carregado</td></tr>';
        }

        // RENDERIZAÇÃO PGDAS COM BOTÃO DE EXCLUIR
        function renderPGDASHistory() {
            const h = JSON.parse(localStorage.getItem('pgdas_pdf_audit')) || [];
            document.getElementById('tbody-pgdas').innerHTML = h.map((it, i) => `
                <tr class="hover:bg-zinc-900/50 transition">
                    <td><b class="text-white uppercase text-[10px]">${it.razao}</b><br><small class="text-zinc-500">${it.cnpj}</small></td>
                    <td class="font-bold text-zinc-400 text-[10px]">R$ ${it.rbt12}</td>
                    <td>${it.atividades.map(a => `
                        <div class="activity-item">
                            <div class="text-[8px] font-black uppercase text-zinc-500">${a.desc} - R$ ${a.receita}</div>
                            <div class="tax-grid">
                                <div class="tax-unit"><span>PIS</span><span>${a.det[3]}</span></div>
                                <div class="tax-unit"><span>COFINS</span><span>${a.det[2]}</span></div>
                                <div class="tax-unit"><span>ICMS</span><span>${a.det[5]}</span></div>
                                <div class="tax-unit"><span>TOTAL</span><span class="text-white font-bold">${a.total}</span></div>
                            </div>
                        </div>`).join('')}</td>
                    <td class="text-orange-500 font-black text-[12px]">R$ ${it.dasTotal}</td>
                    <td>
                        <div class="flex justify-center">
                            <i class="fas fa-trash-alt btn-delete" onclick="deleteEntry('pgdas', ${i})" title="Excluir Período"></i>
                        </div>
                    </td>
                </tr>`).join('') || '<tr><td colspan="5" class="text-center py-20 opacity-30 italic">Nenhum PGDAS carregado</td></tr>';
        }

        // FUNÇÃO PARA EXCLUSÃO INDIVIDUAL
        function deleteEntry(type, index) {
            const key = type === 'xml' ? 'xml_audit_history' : 'pgdas_pdf_audit';
            let data = JSON.parse(localStorage.getItem(key)) || [];
            if(confirm(`Confirmar a exclusão deste período do histórico?`)) {
                data.splice(index, 1);
                localStorage.setItem(key, JSON.stringify(data));
                type === 'xml' ? renderXMLHistory() : renderPGDASHistory();
            }
        }

        // FUNÇÃO PARA LIMPAR TUDO
        function clearFullHistory(type) {
            const key = type === 'xml' ? 'xml_audit_history' : 'pgdas_pdf_audit';
            if(confirm(`ALERTA: Isso apagará TODOS os dados de ${type.toUpperCase()}. Continuar?`)) {
                localStorage.removeItem(key);
                type === 'xml' ? renderXMLHistory() : renderPGDASHistory();
            }
        }

        // ... RESTANTE DAS FUNÇÕES DE DOWNLOAD E TOGGLE MANTIDAS ...
    </script>
</body>
</html>
