// --- MELHORIA DO MÓDULO PGDAS ---
async function processarPGDAS() {
    const h = JSON.parse(localStorage.getItem('pgdas_history')) || [];
    let processados = 0;
    
    for(let file of pgdasFiles) {
        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
        let fullText = "";
        
        // Extração de texto de todas as páginas
        for(let i=1; i<=pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(item => item.str).join(" ") + " ";
        }
        
        // 1. Identificação do Contribuinte [cite: 85, 86, 91, 92]
        const cnpj = (fullText.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/) || [""])[0]; [cite: 91]
        const nomeEmpresa = (fullText.match(/Nome empresarial:\s*(.*?)\s*Data de abertura/i) || ["", "EMPRESA"])[1].trim(); [cite: 92]
        
        // 2. Período de Apuração e Conversão para Extenso 
        const periodoRaw = (fullText.match(/Período de Apuração:\s*([\d/]+)\s*a/i) || ["", ""])[1]; [cite: 84]
        let refExtenso = "Período não identificado";
        if (periodoRaw) {
            const [dia, mes, ano] = periodoRaw.split('/');
            const mesNome = MONTHS_FULL[parseInt(mes)-1];
            refExtenso = `${mesNome} DE ${ano}`;
        }

        // 3. Receitas Brutas (Competência e RBT12) 
        const receitaComp = (fullText.match(/Receita Bruta do PA \(RPA\)\s*-\s*Competência\s*([\d\.,]+)/i) || ["", "0,00"])[1]; [cite: 101]
        const rbt12 = (fullText.match(/Receita bruta acumulada nos doze meses anteriores ao PA \(RBT12\)\s*([\d\.,]+)/i) || ["", "0,00"])[1]; [cite: 101]

        // 4. Extração Dinâmica de Todas as Atividades e Tributos [cite: 115, 116, 120, 121]
        const atividades = [];
        // Regex para capturar cada bloco de "Valor do Débito por Tributo para a Atividade"
        const ativRegex = /Valor do Débito por Tributo para a Atividade \(R\$\):\s*(.*?)\s*Receita Bruta Informada:\s*R\$\s*([\d\.,]+)\s*IRPJ.*?Total\s*([\d\.,\s]+)/gi;
        
        let m;
        while ((m = ativRegex.exec(fullText)) !== null) {
            const descAtividade = m[1].trim(); [cite: 116, 121]
            const valorAtividade = m[2]; [cite: 117, 122]
            
            // Limpa e extrai os valores numéricos dos tributos (IRPJ a Total) [cite: 118, 123]
            const tributosLista = m[3].trim().split(/\s+/).filter(v => v.includes(',') || v.includes('.'));
            
            atividades.push({
                descricao: descAtividade,
                receita: valorAtividade,
                detalhe: {
                    irpj: tributosLista[0] || "0,00",
                    csll: tributosLista[1] || "0,00",
                    cofins: tributosLista[2] || "0,00",
                    pis: tributosLista[3] || "0,00",
                    cpp: tributosLista[4] || "0,00",
                    icms: tributosLista[5] || "0,00",
                    ipi: tributosLista[6] || "0,00",
                    iss: tributosLista[7] || "0,00",
                    total: tributosLista[8] || "0,00"
                }
            });
        }

        h.push({
            empresa: nomeEmpresa,
            cnpj: cnpj,
            ref: refExtenso,
            receitaComp,
            rbt12,
            atividades,
            totalDas: (fullText.match(/Valor Total do DAS:\s*R\$\s*([\d\.,]+)/i) || ["", "0,00"])[1] [cite: 112]
        });
        processados++;
    }

    localStorage.setItem('pgdas_history', JSON.stringify(h));
    alert(`${processados} PGDAS Processados!`);
    renderPGDASHistory();
}
