<script>
        /**
         * FISCAL AUDIT - MOTOR V13.0 (CORREÇÃO DEFINITIVA)
         * Foco: Extração Exata de Dados e Relatório CSV Completo
         */

        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        const MONTHS = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        // --- NAVEGAÇÃO ENTRE ABAS ---
        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) { target.classList.add('active'); target.style.display = 'block'; }
            if(el) el.classList.add('active');
            if(id === 'xml-history-panel') renderXMLHistory();
            if(id === 'pgdas-history-panel') renderPGDASHistory();
        }

        // --- 1. MOTOR DE LEITURA XML ---
        let xmlBuffer = [];

        async function handleXMLFiles(files) {
            xmlBuffer = [];
            const label = document.getElementById('label-xml');
            label.innerText = "Lendo arquivos...";
            
            for (let f of files) {
                if (f.name.toLowerCase().endsWith('.zip')) {
                    try {
                        const zip = await JSZip.loadAsync(f);
                        const xmlFiles = Object.keys(zip.files).filter(x => x.toLowerCase().endsWith('.xml'));
                        for (let p of xmlFiles) {
                            xmlBuffer.push(await zip.files[p].async("text"));
                        }
                    } catch(e) { console.error("Erro ZIP", e); }
                } else if (f.name.toLowerCase().endsWith('.xml')) {
                    xmlBuffer.push(await f.text());
                }
            }
            label.innerText = `${xmlBuffer.length} Arquivos Carregados. Clique em GRAVAR.`;
            document.getElementById('btn-run-xml').disabled = false;
        }

        // Função para encontrar CST/CSOSN independente da estrutura (ICMS00, ICMS10, ICMSSN102, etc)
        function findTaxValue(det, taxGroup, tagNames) {
            const group = det.getElementsByTagName(taxGroup)[0];
            if (!group) return "";
            
            // Tenta encontrar as tags diretamente dentro do grupo (ex: <CST> dentro de <PIS>)
            for (let tag of tagNames) {
                const els = group.getElementsByTagName(tag);
                if (els.length > 0) return els[0].textContent;
            }
            return "";
        }

        function processarXML() {
            if (xmlBuffer.length === 0) return alert("Nenhum arquivo para processar.");
            
            // Carrega histórico atual
            const db = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const tempGroups = {}; // Agrupamento temporário desta carga

            const parser = new DOMParser();

            xmlBuffer.forEach(xmlContent => {
                const xml = parser.parseFromString(xmlContent, "text/xml");
                
                // --- A. DADOS DO CABEÇALHO ---
                const emit = xml.getElementsByTagName("emit")[0];
                const ide = xml.getElementsByTagName("ide")[0];
                
                if (!emit || !ide) return; // Pula XML inválido

                const cnpj = emit.getElementsByTagName("CNPJ")[0]?.textContent || "";
                const xNome = emit.getElementsByTagName("xNome")[0]?.textContent || "DESCONHECIDO";
                const nNF = ide.getElementsByTagName("nNF")[0]?.textContent || "";
                
                // Tratamento Rigoroso da Data
                let dataEmissaoRaw = ide.getElementsByTagName("dhEmi")[0]?.textContent || ide.getElementsByTagName("dEmi")[0]?.textContent;
                if (!dataEmissaoRaw) return;

                const dataObj = new Date(dataEmissaoRaw); // Cria objeto Data
                if (isNaN(dataObj.getTime())) return;

                const mes = dataObj.getMonth(); // 0-11
                const ano = dataObj.getFullYear();
                
                // Formato de exibição: JANEIRO/2026
                const refExibicao = `${MONTHS[mes]}/${ano}`;
                // Chave única para agrupar: CNPJ + ANO + MES
                const groupKey = `${cnpj}_${ano}_${mes}`;

                // --- B. CRIAÇÃO DO GRUPO (SE NÃO EXISTIR) ---
                if (!tempGroups[groupKey]) {
                    tempGroups[groupKey] = {
                        key: groupKey,
                        empresa: xNome,
                        cnpj: cnpj,
                        ref: refExibicao,
                        mesSort: parseInt(`${ano}${mes.toString().padStart(2,'0')}`), // Para ordenar depois
                        qtd: 0,
                        itens: []
                    };
                }

                tempGroups[groupKey].qtd++; // Conta +1 nota neste grupo

                // --- C. DADOS DOS PRODUTOS (ITENS) ---
                const dets = xml.getElementsByTagName("det");
                Array.from(dets).forEach(det => {
                    const prod = det.getElementsByTagName("prod")[0];
                    if (!prod) return;

                    // Busca valores de impostos
                    const cstPis = findTaxValue(det, "PIS", ["CST"]);
                    const cstCofins = findTaxValue(det, "COFINS", ["CST"]);
                    const cstIpi = findTaxValue(det, "IPI", ["CST"]);
                    const icms = findTaxValue(det, "ICMS", ["CST", "CSOSN"]); // Pega CST ou CSOSN

                    tempGroups[groupKey].itens.push({
                        // Dados Cabeçalho para o CSV
                        empresa: xNome,
                        cnpj: cnpj,
                        ref: refExibicao,
                        dataEmissao: dataObj.toLocaleDateString('pt-BR'), // DD/MM/AAAA
                        nota: nNF,
                        
                        // Dados do Produto
                        ncm: prod.getElementsByTagName("NCM")[0]?.textContent || "",
                        xProd: prod.getElementsByTagName("xProd")[0]?.textContent || "",
                        vUn: prod.getElementsByTagName("vUnCom")[0]?.textContent || "0",
                        vTot: prod.getElementsByTagName("vProd")[0]?.textContent || "0",
                        
                        // Impostos
                        pis: cstPis,
                        cofins: cstCofins,
                        ipi: cstIpi,
                        icms: icms
                    });
                });
            });

            // --- D. SALVAR NO LOCALSTORAGE ---
            // Mescla os novos grupos com o banco de dados existente
            Object.values(tempGroups).forEach(novoGrupo => {
                // Verifica se já existe esse CNPJ nesse Mês no banco
                const index = db.findIndex(g => g.key === novoGrupo.key);
                if (index > -1) {
                    // Se existe, atualiza (substitui) para evitar duplicidade de notas
                    db[index] = novoGrupo; 
                } else {
                    db.push(novoGrupo);
                }
            });

            localStorage.setItem('xml_audit_history', JSON.stringify(db));
            
            // Limpa memória e atualiza tela
            xmlBuffer = [];
            document.getElementById('label-xml').innerText = "Carregar arquivos";
            document.getElementById('btn-run-xml').disabled = true;
            
            alert("✅ Processamento Concluído com Sucesso!");
            renderXMLHistory();
        }

        // --- 2. RENDERIZAÇÃO DO HISTÓRICO XML ---
        function renderXMLHistory() {
            const db = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            
            // Ordena: Mais recente primeiro
            db.sort((a, b) => b.mesSort - a.mesSort);

            const tbody = document.getElementById('tbody-xml');
            
            if (db.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-20 opacity-30 italic">Nenhum histórico encontrado. Carregue XMLs.</td></tr>';
                return;
            }

            tbody.innerHTML = db.map((grupo, i) => `
                <tr class="hover:bg-zinc-900 transition-colors">
                    <td><input type="checkbox" class="xml-sel" data-idx="${i}"></td>
                    <td>
                        <b class="text-white uppercase text-[11px] block">${grupo.empresa}</b>
                        <span class="text-zinc-500 text-[10px] tracking-wider">${grupo.cnpj}</span>
                    </td>
                    <td class="text-orange-500 font-bold uppercase text-[11px] tracking-wide">
                        ${grupo.ref}
                    </td>
                    <td class="text-white font-black text-center text-[12px]">
                        ${grupo.qtd}
                    </td>
                    <td>
                        <div class="flex items-center gap-3">
                            <button onclick="baixarRelatorioCSV(${i})" class="bg-[#111] text-zinc-300 border border-zinc-700 hover:text-white hover:border-orange-500 px-3 py-1 rounded text-[9px] font-bold uppercase transition-all">
                                <i class="fas fa-file-csv mr-1"></i> Excel
                            </button>
                            <i class="fas fa-trash-alt trash-icon" onclick="deletarXML(${i})"></i>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // --- 3. GERADOR DE RELATÓRIO (CSV/EXCEL) ---
        function baixarRelatorioCSV(index) {
            const db = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            db.sort((a, b) => b.mesSort - a.mesSort); // Garante a mesma ordem da tela
            
            const grupo = db[index];
            if (!grupo) return;

            // Cabeçalho Oficial pedido
            let csvContent = "Nome da Empresa;CNPJ;Mês Referência;Data Emissão;Nota Fiscal;NCM;Descrição Produto;Vl. Unitário;Vl. Total;CST PIS;CST COFINS;CST/CSOSN ICMS;CST IPI\n";

            grupo.itens.forEach(item => {
                // Tratamento para CSV (Substitui ponto por vírgula e remove ; da descrição)
                const desc = item.xProd.replace(/;/g, " ").trim();
                const vUn = item.vUn.replace('.', ',');
                const vTot = item.vTot.replace('.', ',');

                csvContent += `${item.empresa};${item.cnpj};${item.ref};${item.dataEmissao};${item.nota};${item.ncm};${desc};${vUn};${vTot};${item.pis};${item.cofins};${item.icms};${item.ipi}\n`;
            });

            // Cria o Blob e baixa com BOM para acentuação correta
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const nomeArquivo = `AUDIT_${grupo.empresa.substring(0,10)}_${grupo.ref.replace('/','-')}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = nomeArquivo;
            link.click();
        }

        function exportBatchXML() {
            const db = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            db.sort((a, b) => b.mesSort - a.mesSort);
            
            const checks = document.querySelectorAll('.xml-sel:checked');
            if (checks.length === 0) return alert("Selecione itens para exportar.");

            let csvContent = "Nome da Empresa;CNPJ;Mês Referência;Data Emissão;Nota Fiscal;NCM;Descrição Produto;Vl. Unitário;Vl. Total;CST PIS;CST COFINS;CST/CSOSN ICMS;CST IPI\n";

            checks.forEach(chk => {
                const idx = parseInt(chk.dataset.idx);
                const grupo = db[idx];
                
                grupo.itens.forEach(item => {
                    const desc = item.xProd.replace(/;/g, " ").trim();
                    const vUn = item.vUn.replace('.', ',');
                    const vTot = item.vTot.replace('.', ',');
                    csvContent += `${item.empresa};${item.cnpj};${item.ref};${item.dataEmissao};${item.nota};${item.ncm};${desc};${vUn};${vTot};${item.pis};${item.cofins};${item.icms};${item.ipi}\n`;
                });
            });

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AUDITORIA_CONSOLIDADA_${Date.now()}.csv`;
            link.click();
        }

        function deletarXML(index) {
            if(confirm("Deseja apagar este histórico?")) {
                let db = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
                db.sort((a, b) => b.mesSort - a.mesSort);
                db.splice(index, 1);
                localStorage.setItem('xml_audit_history', JSON.stringify(db));
                renderXMLHistory();
            }
        }
        
        function toggleChecks(source) {
            document.querySelectorAll('.xml-sel').forEach(cb => cb.checked = source.checked);
        }

        // --- 4. MOTOR PGDAS (MANTIDO E FUNCIONAL) ---
        let pgdasFiles = [];
        function handlePGDASFiles(f) { pgdasFiles = Array.from(f); document.getElementById('label-pgdas').innerText = `${f.length} PDFs Prontos`; document.getElementById('btn-run-pgdas').disabled = false; }
        
        async function processarPGDAS() {
            const h = JSON.parse(localStorage.getItem('pgdas_pdf_audit')) || [];
            for(let file of pgdasFiles) {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let text = ""; for(let i=1; i<=pdf.numPages; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(it => it.str).join(" ") + " ";
                const clean = text.replace(/\s+/g, ' ');
                const cnpj = (clean.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/) || [""])[0];
                const p = clean.match(/Período de Apuração:\s*01\/(\d{2})\/(\d{4})/);
                if(!p) continue;
                const ref = `${MONTHS[parseInt(p[1])-1]}/${p[2]}`;
                if(h.some(x => x.cnpj === cnpj && x.ref === ref)) continue;
                let atividades = [];
                clean.split("Valor do Débito por Tributo para a Atividade").slice(1).forEach(b => {
                    const impostos = b.match(/[\d.]+,\d{2}/g);
                    const descMatch = b.match(/^(.*?)\s*Receita Bruta Informada/);
                    if(impostos && impostos.length > 8) {
                        atividades.push({ desc: descMatch ? descMatch[1].trim() : "Atividade", receita: (b.match(/Receita Bruta Informada\s*:\s*R\$\s*([\d.]+,\d{2})/) || ["","0,00"])[1], total: impostos[8], det: impostos });
                    }
                });
                h.push({ razao: (clean.match(/Nome empresarial:\s*(.*?)\s*Data/) || ["","EMPRESA"])[1], cnpj, ref, mSort: parseInt(p[2]+p[1]), rbt12: (clean.match(/RBT12\)\s*[\d.,]+\s*[\d.,]+\s*([\d.]+,\d{2})/) || ["","0,00"])[1], atividades, dasTotal: (clean.match(/Valor Total do DAS:\s*([\d.]+,\d{2})/) || ["","0,00"])[1] });
            }
            localStorage.setItem('pgdas_pdf_audit', JSON.stringify(h));
            alert("✅ PGDAS Gravados!"); renderPGDASHistory();
        }

        function renderPGDASHistory() {
            const h = JSON.parse(localStorage.getItem('pgdas_pdf_audit')) || [];
            document.getElementById('tbody-pgdas').innerHTML = h.map((it, i) => `<tr>
                <td><b class="text-white uppercase text-[10px]">${it.razao}</b><br><small class="text-zinc-500">${it.cnpj} | ${it.ref}</small></td>
                <td class="font-bold text-zinc-400">R$ ${it.rbt12}</td>
                <td>${it.atividades.map(a => `<div class="activity-item">
                    <div class="text-[8px] font-bold text-white uppercase">${a.desc} - R$ ${a.receita}</div>
                    <div class="tax-grid">
                        <div class="tax-unit"><span>PIS</span><span>${a.det[3]}</span></div>
                        <div class="tax-unit"><span>COFINS</span><span>${a.det[2]}</span></div>
                        <div class="tax-unit"><span>ICMS</span><span>${a.det[5]}</span></div>
                        <div class="tax-unit"><span>TOTAL</span><span class="text-white font-bold">${a.total}</span></div>
                    </div></div>`).join('')}</td>
                <td class="text-orange-500 font-black text-[12px]">R$ ${it.dasTotal}</td>
                <td class="text-center"><i class="fas fa-trash-alt trash-icon" onclick="deleteItem('pgdas', ${i})"></i></td></tr>`).join('') || '<tr><td colspan="5" class="text-center py-20 opacity-30 italic">Vazio</td></tr>';
        }

        function deleteItem(type, idx) {
            if(type === 'xml') deletarXML(idx);
            else {
                let d = JSON.parse(localStorage.getItem('pgdas_pdf_audit'));
                if(confirm("Apagar?")) { d.splice(idx, 1); localStorage.setItem('pgdas_pdf_audit', JSON.stringify(d)); renderPGDASHistory(); }
            }
        }
        function clearHistory(type) { if(confirm("Apagar TUDO?")) { localStorage.removeItem(type === 'xml' ? 'xml_audit_history' : 'pgdas_pdf_audit'); type === 'xml' ? renderXMLHistory() : renderPGDASHistory(); } }

        document.addEventListener('DOMContentLoaded', () => { 
            renderXMLHistory(); 
            renderPGDASHistory(); 
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        });
    </script>
