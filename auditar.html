<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUDITORIA INTELIGENTE - V1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --orange-main: #f97316; --bg-dark: #050505; --card-bg: #0a0a0a; --border-color: #1a1a1a; }
        body { background-color: var(--bg-dark); color: #fff; font-family: 'Inter', sans-serif; padding: 30px; }
        .audit-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 20px; border-left: 4px solid var(--orange-main); }
        .table-container { background: #000; border: 1px solid #1a1a1a; border-radius: 10px; overflow: hidden; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: #0d0d0d; color: var(--orange-main); padding: 12px; text-align: left; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 10px 12px; border-bottom: 1px solid #111; color: #eee; }
        .row-error { background: rgba(239, 68, 68, 0.05); }
        .row-error td { color: #f87171; }
        .badge-error { background: #450a0a; color: #f87171; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 8px; }
        .badge-ok { background: #064e3b; color: #34d399; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 8px; }
        .btn-audit { background: var(--orange-main); color: #000; font-weight: 900; padding: 10px 20px; border-radius: 6px; text-transform: uppercase; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .btn-audit:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(249, 115, 22, 0.4); }
    </style>
</head>
<body>

    <header class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-3xl font-black italic tracking-tighter uppercase text-white">Auditoria <span class="text-orange-500">Automática</span></h1>
            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Cruzamento de NCM vs Legislação Federal e Estadual (SP)</p>
        </div>
        <div class="flex gap-4">
            <select id="select-empresa" class="bg-zinc-900 border border-zinc-800 text-white text-[10px] font-bold p-2 rounded outline-none uppercase cursor-pointer">
                <option value="">Selecione uma empresa do histórico</option>
            </select>
            <button onclick="executarAuditoria()" class="btn-audit">Executar Auditoria</button>
        </div>
    </header>

    <div id="dashboard-resumo" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden">
        <div class="audit-card">
            <p class="text-zinc-500 text-[9px] font-black uppercase">Total de Itens</p>
            <h2 id="resumo-total" class="text-3xl font-black italic">0</h2>
        </div>
        <div class="audit-card" style="border-left-color: #ef4444;">
            <p class="text-zinc-500 text-[9px] font-black uppercase">Inconsistências (CST Errado)</p>
            <h2 id="resumo-erros" class="text-3xl font-black italic text-red-500">0</h2>
        </div>
        <div class="audit-card" style="border-left-color: #10b981;">
            <p class="text-zinc-500 text-[9px] font-black uppercase">Crédito Estimado</p>
            <h2 id="resumo-credito" class="text-3xl font-black italic text-green-500">R$ 0,00</h2>
        </div>
    </div>

    <div id="results-area" class="table-container hidden">
        <table>
            <thead>
                <tr>
                    <th>Nota</th>
                    <th>Produto / NCM</th>
                    <th>CST XML</th>
                    <th>Regra (Auditado)</th>
                    <th>Sugestão CST</th>
                    <th>Divergência</th>
                    <th>Impacto</th>
                </tr>
            </thead>
            <tbody id="tbody-audit"></tbody>
        </table>
    </div>

    <script>
        // --- BASE DE CONHECIMENTO FISCAL (RESUMO DOS SEUS ANEXOS) ---
        // Aqui o sistema guarda quais NCMs pertencem a quais regras
        const REGRAS_FISCAIS = {
            federal: {
                monofasicos: ["8708", "4011", "4013", "8433", "8432", "3819", "3403"], // Ex: Autopeças e Pneus
                aliquotaZero: ["0207", "1006", "1101", "1902"] // Alimentos Cesta Básica
            },
            estadual_sp: {
                st_auto: ["8708", "4011", "4013", "8512", "9029"], // Anexo XIV
                st_alimentos: ["1901", "1905", "2103", "2106"], // Anexo XII
                st_bebidas: ["2201", "2202", "2203"] // Anexo IV
            }
        };

        // Carrega as empresas do histórico principal (index.html)
        function init() {
            const h = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const select = document.getElementById('select-empresa');
            h.forEach((item, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = `${item.empresa} (${item.ref})`;
                select.appendChild(opt);
            });
        }

        function executarAuditoria() {
            const idx = document.getElementById('select-empresa').value;
            if (idx === "") return alert("Selecione uma empresa!");

            const db = JSON.parse(localStorage.getItem('xml_audit_history')) || [];
            const dadosEmpresa = db[idx];
            const tbody = document.getElementById('tbody-audit');
            
            document.getElementById('dashboard-resumo').classList.remove('hidden');
            document.getElementById('results-area').classList.remove('hidden');
            
            tbody.innerHTML = '';
            let errosCount = 0;
            let totalCredito = 0;

            dadosEmpresa.itens.forEach(item => {
                let auditoria = {
                    status: "OK",
                    regra: "TRIBUTADO NORMAL",
                    sugestao: item.cst,
                    impacto: 0
                };

                const ncmReduzido = item.ncm.substring(0, 4);

                // 1. TESTE MONOFÁSICO (FEDERAL)
                if (REGRAS_FISCAIS.federal.monofasicos.includes(ncmReduzido)) {
                    auditoria.regra = "PIS/COFINS MONOFÁSICO";
                    auditoria.sugestao = "04"; // CST Monofásico Simples
                    if (item.cst !== "04") {
                        auditoria.status = "ERRO";
                        auditoria.impacto = parseFloat(item.valor) * 0.0198; // Exemplo de recuperação
                    }
                }

                // 2. TESTE SUBSTITUIÇÃO TRIBUTÁRIA (ESTADUAL SP)
                if (REGRAS_FISCAIS.estadual_sp.st_auto.includes(ncmReduzido)) {
                    auditoria.regra = "ICMS ST (ANEXO XIV)";
                    auditoria.sugestao = "500"; // CSOSN 500 ou CST 60
                    if (item.cst === "00" || item.cst === "102") {
                        auditoria.status = "ERRO";
                    }
                }

                if (auditoria.status === "ERRO") errosCount++;
                totalCredito += auditoria.impacto;

                const tr = document.createElement('tr');
                if (auditoria.status === "ERRO") tr.className = "row-error";
                
                tr.innerHTML = `
                    <td class="font-bold">${item.nota || '---'}</td>
                    <td><b class="uppercase">${item.prod}</b><br><span class="text-zinc-500 font-mono">NCM: ${item.ncm}</span></td>
                    <td class="font-bold">${item.cst}</td>
                    <td class="text-[9px] font-bold">${auditoria.regra}</td>
                    <td class="font-black text-orange-500">${auditoria.sugestao}</td>
                    <td><span class="${auditoria.status === 'ERRO' ? 'badge-error' : 'badge-ok'}">${auditoria.status === 'ERRO' ? 'DIVERGENTE' : 'CONFORME'}</span></td>
                    <td class="font-bold text-green-500">${auditoria.impacto > 0 ? 'R$ ' + auditoria.impacto.toLocaleString('pt-BR', {minimumFractionDigits:2}) : '---'}</td>
                `;
                tbody.appendChild(tr);
            });

            // Atualiza o Dashboard
            document.getElementById('resumo-total').textContent = dadosEmpresa.itens.length;
            document.getElementById('resumo-erros').textContent = errosCount;
            document.getElementById('resumo-credito').textContent = `R$ ${totalCredito.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        }

        window.onload = init;
    </script>
</body>
</html>